{
  "url": "https://api.github.com/repos/apache/spark/issues/40561",
  "repository_url": "https://api.github.com/repos/apache/spark",
  "labels_url": "https://api.github.com/repos/apache/spark/issues/40561/labels{/name}",
  "comments_url": "https://api.github.com/repos/apache/spark/issues/40561/comments",
  "events_url": "https://api.github.com/repos/apache/spark/issues/40561/events",
  "html_url": "https://github.com/apache/spark/pull/40561",
  "id": 1641614455,
  "node_id": "PR_kwDOAQXtWs5M8k9N",
  "number": 40561,
  "title": "[SPARK-42931][SS] Introduce dropDuplicatesWithinWatermark",
  "user": {
    "login": "HeartSaVioR",
    "id": 1317309,
    "node_id": "MDQ6VXNlcjEzMTczMDk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1317309?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/HeartSaVioR",
    "html_url": "https://github.com/HeartSaVioR",
    "followers_url": "https://api.github.com/users/HeartSaVioR/followers",
    "following_url": "https://api.github.com/users/HeartSaVioR/following{/other_user}",
    "gists_url": "https://api.github.com/users/HeartSaVioR/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/HeartSaVioR/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/HeartSaVioR/subscriptions",
    "organizations_url": "https://api.github.com/users/HeartSaVioR/orgs",
    "repos_url": "https://api.github.com/users/HeartSaVioR/repos",
    "events_url": "https://api.github.com/users/HeartSaVioR/events{/privacy}",
    "received_events_url": "https://api.github.com/users/HeartSaVioR/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1405794576,
      "node_id": "MDU6TGFiZWwxNDA1Nzk0NTc2",
      "url": "https://api.github.com/repos/apache/spark/labels/SQL",
      "name": "SQL",
      "color": "ededed",
      "default": false,
      "description": null
    },
    {
      "id": 1406587328,
      "node_id": "MDU6TGFiZWwxNDA2NTg3MzI4",
      "url": "https://api.github.com/repos/apache/spark/labels/STRUCTURED%20STREAMING",
      "name": "STRUCTURED STREAMING",
      "color": "ededed",
      "default": false,
      "description": null
    },
    {
      "id": 1981471081,
      "node_id": "MDU6TGFiZWwxOTgxNDcxMDgx",
      "url": "https://api.github.com/repos/apache/spark/labels/DOCS",
      "name": "DOCS",
      "color": "ededed",
      "default": false,
      "description": null
    },
    {
      "id": 1981527456,
      "node_id": "MDU6TGFiZWwxOTgxNTI3NDU2",
      "url": "https://api.github.com/repos/apache/spark/labels/CORE",
      "name": "CORE",
      "color": "ededed",
      "default": false,
      "description": null
    },
    {
      "id": 1982260031,
      "node_id": "MDU6TGFiZWwxOTgyMjYwMDMx",
      "url": "https://api.github.com/repos/apache/spark/labels/PYTHON",
      "name": "PYTHON",
      "color": "ededed",
      "default": false,
      "description": null
    },
    {
      "id": 4556440342,
      "node_id": "LA_kwDOAQXtWs8AAAABD5XDFg",
      "url": "https://api.github.com/repos/apache/spark/labels/CONNECT",
      "name": "CONNECT",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 18,
  "created_at": "2023-03-27T08:11:46Z",
  "updated_at": "2023-04-28T00:25:45Z",
  "closed_at": "2023-04-08T13:45:03Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/apache/spark/pulls/40561",
    "html_url": "https://github.com/apache/spark/pull/40561",
    "diff_url": "https://github.com/apache/spark/pull/40561.diff",
    "patch_url": "https://github.com/apache/spark/pull/40561.patch",
    "merged_at": null
  },
  "body": "### What changes were proposed in this pull request?\r\n\r\nThis PR proposes to introduce a new API of dropDuplicates which has following different characteristics compared to existing dropDuplicates:\r\n\r\n* Weaker constraints on the subset (key)\r\n  * Does not require an event time column on the subset.\r\n* Looser semantics on deduplication\r\n  * Only guarantee to deduplicate events within watermark delay.\r\n\r\nSince the new API leverages event time, the new API has following new requirements:\r\n\r\n* The watermark must be defined in the streaming DataFrame\r\n* The event time column must be defined in the streaming DataFrame.\r\n\r\nMore specifically on the semantic, once the operator processes the first arrived event, events arriving within the watermark for the first event will be deduplicated.\r\n(Technically, the expiration time should be the “event time of the first arrived event + watermark delay threshold”, to match up with future events.)\r\n\r\nUsers are encouraged to set the delay threshold of watermark longer than max timestamp differences among duplicated events. (If they are unsure, they can alternatively set the delay threshold large enough, e.g. 48 hours.)\r\n\r\nFor batch DataFrame, this is equivalent to the dropDuplicates.\r\n\r\nThis PR also updates the SS guide doc to introduce the new feature; screenshots below:\r\n\r\n<img width=\"747\" alt=\"스크린샷 2023-04-06 오전 11 09 12\" src=\"https://user-images.githubusercontent.com/1317309/230254868-7fe76175-5883-4700-b018-d85d851799cb.png\">\r\n<img width=\"749\" alt=\"스크린샷 2023-04-06 오전 11 09 18\" src=\"https://user-images.githubusercontent.com/1317309/230254874-a754cdfd-2832-41dd-85b6-291f05eccb3d.png\">\r\n<img width=\"752\" alt=\"스크린샷 2023-04-06 오전 11 09 23\" src=\"https://user-images.githubusercontent.com/1317309/230254876-7fd7b3b1-f59d-481f-8249-5a4ae556c7cf.png\">\r\n<img width=\"751\" alt=\"스크린샷 2023-04-06 오전 11 09 29\" src=\"https://user-images.githubusercontent.com/1317309/230254880-79b158ca-3403-46a6-be4a-46618ec749db.png\">\r\n\r\n\r\n### Why are the changes needed?\r\n\r\nExisting dropDuplicates API does not address the valid use case on streaming query.\r\n\r\nThere are many cases where the event time is not exact the same, although these events are same. One example is duplicated events are produced due to non-idempotent writer where event time is issued from producer/broker side. Another example is that the value of event time is unstable and users want to use alternative timestamp e.g. ingestion time.\r\n\r\nFor these case, users have to exclude event time column from subset of deduplication, but then the operator is unable to evict state, leading to indefinitely growing state.\r\n\r\nTo allow eviction of state while event time column is not required to be a part of subset of deduplication, we need to loose the semantic for the API, which warrants a new API.\r\n\r\n### Does this PR introduce _any_ user-facing change?\r\n\r\nYes, this introduces a new public API, dropDuplicatesWithinWatermark.\r\n\r\n### How was this patch tested?\r\n\r\nNew test suite.",
  "closed_by": {
    "login": "HeartSaVioR",
    "id": 1317309,
    "node_id": "MDQ6VXNlcjEzMTczMDk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1317309?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/HeartSaVioR",
    "html_url": "https://github.com/HeartSaVioR",
    "followers_url": "https://api.github.com/users/HeartSaVioR/followers",
    "following_url": "https://api.github.com/users/HeartSaVioR/following{/other_user}",
    "gists_url": "https://api.github.com/users/HeartSaVioR/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/HeartSaVioR/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/HeartSaVioR/subscriptions",
    "organizations_url": "https://api.github.com/users/HeartSaVioR/orgs",
    "repos_url": "https://api.github.com/users/HeartSaVioR/repos",
    "events_url": "https://api.github.com/users/HeartSaVioR/events{/privacy}",
    "received_events_url": "https://api.github.com/users/HeartSaVioR/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/apache/spark/issues/40561/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/apache/spark/issues/40561/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
