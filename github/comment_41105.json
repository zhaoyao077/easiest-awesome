[
  {
    "url": "https://api.github.com/repos/apache/spark/issues/comments/1540504315",
    "html_url": "https://github.com/apache/spark/pull/41105#issuecomment-1540504315",
    "issue_url": "https://api.github.com/repos/apache/spark/issues/41105",
    "id": 1540504315,
    "node_id": "IC_kwDOAQXtWs5b0jr7",
    "user": {
      "login": "zhouyifan279",
      "id": 88070094,
      "node_id": "MDQ6VXNlcjg4MDcwMDk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/88070094?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zhouyifan279",
      "html_url": "https://github.com/zhouyifan279",
      "followers_url": "https://api.github.com/users/zhouyifan279/followers",
      "following_url": "https://api.github.com/users/zhouyifan279/following{/other_user}",
      "gists_url": "https://api.github.com/users/zhouyifan279/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zhouyifan279/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zhouyifan279/subscriptions",
      "organizations_url": "https://api.github.com/users/zhouyifan279/orgs",
      "repos_url": "https://api.github.com/users/zhouyifan279/repos",
      "events_url": "https://api.github.com/users/zhouyifan279/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zhouyifan279/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-09T16:32:32Z",
    "updated_at": "2023-05-09T16:32:32Z",
    "author_association": "CONTRIBUTOR",
    "body": "cc @srowen",
    "reactions": {
      "url": "https://api.github.com/repos/apache/spark/issues/comments/1540504315/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/apache/spark/issues/comments/1541270960",
    "html_url": "https://github.com/apache/spark/pull/41105#issuecomment-1541270960",
    "issue_url": "https://api.github.com/repos/apache/spark/issues/41105",
    "id": 1541270960,
    "node_id": "IC_kwDOAQXtWs5b3e2w",
    "user": {
      "login": "zhouyifan279",
      "id": 88070094,
      "node_id": "MDQ6VXNlcjg4MDcwMDk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/88070094?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zhouyifan279",
      "html_url": "https://github.com/zhouyifan279",
      "followers_url": "https://api.github.com/users/zhouyifan279/followers",
      "following_url": "https://api.github.com/users/zhouyifan279/following{/other_user}",
      "gists_url": "https://api.github.com/users/zhouyifan279/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zhouyifan279/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zhouyifan279/subscriptions",
      "organizations_url": "https://api.github.com/users/zhouyifan279/orgs",
      "repos_url": "https://api.github.com/users/zhouyifan279/repos",
      "events_url": "https://api.github.com/users/zhouyifan279/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zhouyifan279/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-10T03:10:35Z",
    "updated_at": "2023-05-10T03:10:35Z",
    "author_association": "CONTRIBUTOR",
    "body": "cc @LuciferYang ",
    "reactions": {
      "url": "https://api.github.com/repos/apache/spark/issues/comments/1541270960/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/apache/spark/issues/comments/1541571622",
    "html_url": "https://github.com/apache/spark/pull/41105#issuecomment-1541571622",
    "issue_url": "https://api.github.com/repos/apache/spark/issues/41105",
    "id": 1541571622,
    "node_id": "IC_kwDOAQXtWs5b4oQm",
    "user": {
      "login": "zhouyifan279",
      "id": 88070094,
      "node_id": "MDQ6VXNlcjg4MDcwMDk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/88070094?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zhouyifan279",
      "html_url": "https://github.com/zhouyifan279",
      "followers_url": "https://api.github.com/users/zhouyifan279/followers",
      "following_url": "https://api.github.com/users/zhouyifan279/following{/other_user}",
      "gists_url": "https://api.github.com/users/zhouyifan279/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zhouyifan279/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zhouyifan279/subscriptions",
      "organizations_url": "https://api.github.com/users/zhouyifan279/orgs",
      "repos_url": "https://api.github.com/users/zhouyifan279/repos",
      "events_url": "https://api.github.com/users/zhouyifan279/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zhouyifan279/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-10T08:28:50Z",
    "updated_at": "2023-05-10T09:47:52Z",
    "author_association": "CONTRIBUTOR",
    "body": "Here are some key code segments:\r\n\r\n1. Old SparkUI  goes into `com.google.common.cache.LocalCache#removalNotificationQueue` when it is removed from `appCache`.\r\n\r\n**com.google.common.cache.LocalCache.Segment**\r\n```java\r\n    @GuardedBy(\"Segment.this\")\r\n    @Nullable\r\n    ReferenceEntry<K, V> removeValueFromChain(ReferenceEntry<K, V> first,\r\n        ReferenceEntry<K, V> entry, @Nullable K key, int hash, ValueReference<K, V> valueReference,\r\n        RemovalCause cause) {\r\n      // Put removed value into removalNotificationQueue\r\n      enqueueNotification(key, hash, valueReference, cause);\r\n      writeQueue.remove(entry);\r\n      accessQueue.remove(entry);\r\n\r\n      if (valueReference.isLoading()) {\r\n        valueReference.notifyNewValue(null);\r\n        return first;\r\n      } else {\r\n        return removeEntryFromChain(first, entry);\r\n      }\r\n    }\r\n```\r\n\r\n2. Execution of `removalListener#onRemoval` is not guarded by `appCache`'s lock\r\n\r\n**com.google.common.cache.LocalCache.Segment**\r\n```java\r\n    V lockedGetOrLoad(K key, int hash, CacheLoader<? super K, V> loader)\r\n        throws ExecutionException {\r\n      ReferenceEntry<K, V> e;\r\n      ValueReference<K, V> valueReference = null;\r\n      LoadingValueReference<K, V> loadingValueReference = null;\r\n      boolean createNewEntry = true;\r\n\r\n      lock();\r\n      try {\r\n         ...\r\n      } finally {\r\n        unlock();\r\n        // `removalListener#onRemoval` executes inside postWriteCleanup()\r\n        postWriteCleanup();\r\n      }\r\n      ...\r\n    }\r\n```\r\n\r\n3. New SparkUI is detached unexpectedly during detaching of old SparkUI\r\n\r\n**FsHistoryProvider**\r\n```scala\r\n  override def onUIDetached(appId: String, attemptId: Option[String], ui: SparkUI): Unit = {\r\n    val uiOption = synchronized {\r\n      // After new SparkUI is loaded, `activeUIs` contains new SparkUI\r\n      activeUIs.remove((appId, attemptId))\r\n    }\r\n    uiOption.foreach { loadedUI =>\r\n      loadedUI.lock.writeLock().lock()\r\n      try {\r\n        loadedUI.ui.store.close()\r\n      } finally {\r\n        loadedUI.lock.writeLock().unlock()\r\n      }\r\n\r\n      diskManager.foreach { dm =>\r\n        // If the UI is not valid, delete its files from disk, if any. This relies on the fact that\r\n        // ApplicationCache will never call this method concurrently with getAppUI() for the same\r\n        // appId / attemptId.\r\n        dm.release(appId, attemptId, delete = !loadedUI.valid)\r\n      }\r\n    }\r\n  }\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/apache/spark/issues/comments/1541571622/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/apache/spark/issues/comments/1541576100",
    "html_url": "https://github.com/apache/spark/pull/41105#issuecomment-1541576100",
    "issue_url": "https://api.github.com/repos/apache/spark/issues/41105",
    "id": 1541576100,
    "node_id": "IC_kwDOAQXtWs5b4pWk",
    "user": {
      "login": "zhouyifan279",
      "id": 88070094,
      "node_id": "MDQ6VXNlcjg4MDcwMDk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/88070094?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zhouyifan279",
      "html_url": "https://github.com/zhouyifan279",
      "followers_url": "https://api.github.com/users/zhouyifan279/followers",
      "following_url": "https://api.github.com/users/zhouyifan279/following{/other_user}",
      "gists_url": "https://api.github.com/users/zhouyifan279/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zhouyifan279/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zhouyifan279/subscriptions",
      "organizations_url": "https://api.github.com/users/zhouyifan279/orgs",
      "repos_url": "https://api.github.com/users/zhouyifan279/repos",
      "events_url": "https://api.github.com/users/zhouyifan279/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zhouyifan279/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-10T08:32:09Z",
    "updated_at": "2023-05-10T08:32:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "@srowen @LuciferYang Added some code segments to help to understand this issue.",
    "reactions": {
      "url": "https://api.github.com/repos/apache/spark/issues/comments/1541576100/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/apache/spark/issues/comments/1542317728",
    "html_url": "https://github.com/apache/spark/pull/41105#issuecomment-1542317728",
    "issue_url": "https://api.github.com/repos/apache/spark/issues/41105",
    "id": 1542317728,
    "node_id": "IC_kwDOAQXtWs5b7eag",
    "user": {
      "login": "steveloughran",
      "id": 162090,
      "node_id": "MDQ6VXNlcjE2MjA5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/162090?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/steveloughran",
      "html_url": "https://github.com/steveloughran",
      "followers_url": "https://api.github.com/users/steveloughran/followers",
      "following_url": "https://api.github.com/users/steveloughran/following{/other_user}",
      "gists_url": "https://api.github.com/users/steveloughran/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/steveloughran/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/steveloughran/subscriptions",
      "organizations_url": "https://api.github.com/users/steveloughran/orgs",
      "repos_url": "https://api.github.com/users/steveloughran/repos",
      "events_url": "https://api.github.com/users/steveloughran/events{/privacy}",
      "received_events_url": "https://api.github.com/users/steveloughran/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-10T14:33:21Z",
    "updated_at": "2023-05-10T14:33:21Z",
    "author_association": "CONTRIBUTOR",
    "body": "don't remember the cache stuff, sorry. I know we have a problem in hadoop where cache lookup can trigger >1 fs creation and the same time, and if that is slow then at best: needless work, at worst: conflict and sometimes failures. so we use a semaphore to limit the #of threads which can create a new FS at the same time (HADOOP-17313). spark/tez workers and cloud stores doing network IO in initialize() are the troublespot here, FWIW.",
    "reactions": {
      "url": "https://api.github.com/repos/apache/spark/issues/comments/1542317728/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/apache/spark/issues/comments/1543275831",
    "html_url": "https://github.com/apache/spark/pull/41105#issuecomment-1543275831",
    "issue_url": "https://api.github.com/repos/apache/spark/issues/41105",
    "id": 1543275831,
    "node_id": "IC_kwDOAQXtWs5b_IU3",
    "user": {
      "login": "zhouyifan279",
      "id": 88070094,
      "node_id": "MDQ6VXNlcjg4MDcwMDk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/88070094?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zhouyifan279",
      "html_url": "https://github.com/zhouyifan279",
      "followers_url": "https://api.github.com/users/zhouyifan279/followers",
      "following_url": "https://api.github.com/users/zhouyifan279/following{/other_user}",
      "gists_url": "https://api.github.com/users/zhouyifan279/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zhouyifan279/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zhouyifan279/subscriptions",
      "organizations_url": "https://api.github.com/users/zhouyifan279/orgs",
      "repos_url": "https://api.github.com/users/zhouyifan279/repos",
      "events_url": "https://api.github.com/users/zhouyifan279/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zhouyifan279/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-11T03:23:50Z",
    "updated_at": "2023-05-11T03:26:03Z",
    "author_association": "CONTRIBUTOR",
    "body": "> don't remember the cache stuff, sorry. I know we have a problem in hadoop where cache lookup can trigger >1 fs creation and the same time, and if that is slow then at best: needless work, at worst: conflict and sometimes failures. so we use a semaphore to limit the #of threads which can create a new FS at the same time (HADOOP-17313). spark/tez workers and cloud stores doing network IO in initialize() are the troublespot here, FWIW.\r\n\r\n@steveloughran Thanks for your inputs.\r\n\r\nIn SparkHistoryServer, SparkUIs are tracked by <appId, attemptId> in many places:\r\n1. `ApplicationCache#appCache`\r\n2. `FsHistoryProvider#activeUIs`\r\n3. `HistoryServerDiskManager#active`\r\n4. Disk-based KVStore backend local path: appStoreDir/\\<appId>_\\<attemptId>/\r\n5. Disk-based KVStore backend local file lock: appStoreDir/\\<appId>_\\<attemptId>/LOCK\r\n\r\nAll the above places assumes there is only one SparkUI loaded for one <appId, attemptId> pair.\r\n\r\nGuava LoadingCache can ensure this when SparkUIs are guarded by its locks.\r\nBut SparkUI's detaching is not guarded by LoadingCache's lock.  \r\n\r\nThis PR is aimed to ensure this from SparkUI's loading to detaching.",
    "reactions": {
      "url": "https://api.github.com/repos/apache/spark/issues/comments/1543275831/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/apache/spark/issues/comments/1544115380",
    "html_url": "https://github.com/apache/spark/pull/41105#issuecomment-1544115380",
    "issue_url": "https://api.github.com/repos/apache/spark/issues/41105",
    "id": 1544115380,
    "node_id": "IC_kwDOAQXtWs5cCVS0",
    "user": {
      "login": "zhouyifan279",
      "id": 88070094,
      "node_id": "MDQ6VXNlcjg4MDcwMDk0",
      "avatar_url": "https://avatars.githubusercontent.com/u/88070094?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zhouyifan279",
      "html_url": "https://github.com/zhouyifan279",
      "followers_url": "https://api.github.com/users/zhouyifan279/followers",
      "following_url": "https://api.github.com/users/zhouyifan279/following{/other_user}",
      "gists_url": "https://api.github.com/users/zhouyifan279/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zhouyifan279/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zhouyifan279/subscriptions",
      "organizations_url": "https://api.github.com/users/zhouyifan279/orgs",
      "repos_url": "https://api.github.com/users/zhouyifan279/repos",
      "events_url": "https://api.github.com/users/zhouyifan279/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zhouyifan279/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-11T14:42:22Z",
    "updated_at": "2023-05-11T14:42:22Z",
    "author_association": "CONTRIBUTOR",
    "body": "@LuciferYang Exception \"java.lang.IllegalStateException: DB is closed.\" can be reproduced in test now.\r\n\r\n<img width=\"1138\" alt=\"image\" src=\"https://github.com/apache/spark/assets/88070094/cea0d752-4323-40ef-b4d1-5ec457fc267e\">\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/apache/spark/issues/comments/1544115380/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/apache/spark/issues/comments/1544930839",
    "html_url": "https://github.com/apache/spark/pull/41105#issuecomment-1544930839",
    "issue_url": "https://api.github.com/repos/apache/spark/issues/41105",
    "id": 1544930839,
    "node_id": "IC_kwDOAQXtWs5cFcYX",
    "user": {
      "login": "mridulm",
      "id": 1591700,
      "node_id": "MDQ6VXNlcjE1OTE3MDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1591700?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mridulm",
      "html_url": "https://github.com/mridulm",
      "followers_url": "https://api.github.com/users/mridulm/followers",
      "following_url": "https://api.github.com/users/mridulm/following{/other_user}",
      "gists_url": "https://api.github.com/users/mridulm/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mridulm/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mridulm/subscriptions",
      "organizations_url": "https://api.github.com/users/mridulm/orgs",
      "repos_url": "https://api.github.com/users/mridulm/repos",
      "events_url": "https://api.github.com/users/mridulm/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mridulm/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-12T00:28:09Z",
    "updated_at": "2023-05-12T00:28:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "+CC @thejdeep ",
    "reactions": {
      "url": "https://api.github.com/repos/apache/spark/issues/comments/1544930839/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/apache/spark/issues/comments/1547067573",
    "html_url": "https://github.com/apache/spark/pull/41105#issuecomment-1547067573",
    "issue_url": "https://api.github.com/repos/apache/spark/issues/41105",
    "id": 1547067573,
    "node_id": "IC_kwDOAQXtWs5cNmC1",
    "user": {
      "login": "HyukjinKwon",
      "id": 6477701,
      "node_id": "MDQ6VXNlcjY0Nzc3MDE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6477701?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/HyukjinKwon",
      "html_url": "https://github.com/HyukjinKwon",
      "followers_url": "https://api.github.com/users/HyukjinKwon/followers",
      "following_url": "https://api.github.com/users/HyukjinKwon/following{/other_user}",
      "gists_url": "https://api.github.com/users/HyukjinKwon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/HyukjinKwon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/HyukjinKwon/subscriptions",
      "organizations_url": "https://api.github.com/users/HyukjinKwon/orgs",
      "repos_url": "https://api.github.com/users/HyukjinKwon/repos",
      "events_url": "https://api.github.com/users/HyukjinKwon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/HyukjinKwon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2023-05-15T01:26:28Z",
    "updated_at": "2023-05-15T01:26:28Z",
    "author_association": "MEMBER",
    "body": "cc @gengliangwang and @sarutak too FYI",
    "reactions": {
      "url": "https://api.github.com/repos/apache/spark/issues/comments/1547067573/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]
