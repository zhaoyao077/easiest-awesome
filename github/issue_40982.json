{
  "url": "https://api.github.com/repos/apache/spark/issues/40982",
  "repository_url": "https://api.github.com/repos/apache/spark",
  "labels_url": "https://api.github.com/repos/apache/spark/issues/40982/labels{/name}",
  "comments_url": "https://api.github.com/repos/apache/spark/issues/40982/comments",
  "events_url": "https://api.github.com/repos/apache/spark/issues/40982/events",
  "html_url": "https://github.com/apache/spark/pull/40982",
  "id": 1687547353,
  "node_id": "PR_kwDOAQXtWs5PVXVA",
  "number": 40982,
  "title": "[SPARK-43300][CORE] NonFateSharingCache wrapper for Guava Cache",
  "user": {
    "login": "liuzqt",
    "id": 22358241,
    "node_id": "MDQ6VXNlcjIyMzU4MjQx",
    "avatar_url": "https://avatars.githubusercontent.com/u/22358241?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/liuzqt",
    "html_url": "https://github.com/liuzqt",
    "followers_url": "https://api.github.com/users/liuzqt/followers",
    "following_url": "https://api.github.com/users/liuzqt/following{/other_user}",
    "gists_url": "https://api.github.com/users/liuzqt/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/liuzqt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/liuzqt/subscriptions",
    "organizations_url": "https://api.github.com/users/liuzqt/orgs",
    "repos_url": "https://api.github.com/users/liuzqt/repos",
    "events_url": "https://api.github.com/users/liuzqt/events{/privacy}",
    "received_events_url": "https://api.github.com/users/liuzqt/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1405794576,
      "node_id": "MDU6TGFiZWwxNDA1Nzk0NTc2",
      "url": "https://api.github.com/repos/apache/spark/labels/SQL",
      "name": "SQL",
      "color": "ededed",
      "default": false,
      "description": null
    },
    {
      "id": 1981527456,
      "node_id": "MDU6TGFiZWwxOTgxNTI3NDU2",
      "url": "https://api.github.com/repos/apache/spark/labels/CORE",
      "name": "CORE",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2023-04-27T21:02:48Z",
  "updated_at": "2023-05-16T01:48:42Z",
  "closed_at": "2023-05-16T01:48:14Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/apache/spark/pulls/40982",
    "html_url": "https://github.com/apache/spark/pull/40982",
    "diff_url": "https://github.com/apache/spark/pull/40982.diff",
    "patch_url": "https://github.com/apache/spark/pull/40982.patch",
    "merged_at": null
  },
  "body": "### What changes were proposed in this pull request?\r\n\r\nCreate `NonFateSharingCache` to wrap around Guava cache with a KeyLock to synchronize all requests with the same key, so they will run individually and fail as if they come one at a time.\r\n\r\nWrap cache in `CodeGenerator` with `NonFateSharingCache` to protect it from unexpected cascade failure due to cancellation from irrelevant queries that loading the same key. Feel free to use this in other places where we used Guava cache and don't want fate-sharing behavior.\r\n\r\nAlso, instead of implementing Guava Cache and LoadingCache interface, I define a subset of it so that we can control at compile time what cache operations are allowed and make sure all cache loading action go through our narrow waist code path with key lock. Feel free to add new APIs when needed.\r\n\r\n### Why are the changes needed?\r\n\r\nGuava cache is widely used in spark, however, it suffers from fate-sharing behavior: If there are multiple requests trying to access the same key in the cache at the same time when the key is not in the cache, Guava cache will block all requests and create the object only once. If the creation fails, all requests will fail immediately without retry. So we might see task failure due to irrelevant failure in other queries due to fate sharing.\r\n\r\nThis fate sharing behavior leads to unexpected results in some situation(for example, in code gen).\r\n\r\n### Does this PR introduce _any_ user-facing change?\r\n\r\nNo\r\n\r\n\r\n### How was this patch tested?\r\nUT\r\n",
  "closed_by": {
    "login": "JoshRosen",
    "id": 50748,
    "node_id": "MDQ6VXNlcjUwNzQ4",
    "avatar_url": "https://avatars.githubusercontent.com/u/50748?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/JoshRosen",
    "html_url": "https://github.com/JoshRosen",
    "followers_url": "https://api.github.com/users/JoshRosen/followers",
    "following_url": "https://api.github.com/users/JoshRosen/following{/other_user}",
    "gists_url": "https://api.github.com/users/JoshRosen/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/JoshRosen/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/JoshRosen/subscriptions",
    "organizations_url": "https://api.github.com/users/JoshRosen/orgs",
    "repos_url": "https://api.github.com/users/JoshRosen/repos",
    "events_url": "https://api.github.com/users/JoshRosen/events{/privacy}",
    "received_events_url": "https://api.github.com/users/JoshRosen/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/apache/spark/issues/40982/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/apache/spark/issues/40982/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
