{
  "url": "https://api.github.com/repos/apache/spark/issues/41198",
  "repository_url": "https://api.github.com/repos/apache/spark",
  "labels_url": "https://api.github.com/repos/apache/spark/issues/41198/labels{/name}",
  "comments_url": "https://api.github.com/repos/apache/spark/issues/41198/comments",
  "events_url": "https://api.github.com/repos/apache/spark/issues/41198/events",
  "html_url": "https://github.com/apache/spark/pull/41198",
  "id": 1713512822,
  "node_id": "PR_kwDOAQXtWs5QsZ2a",
  "number": 41198,
  "title": "[SPARK-43537][INFA][BUILD] Upgrading the ASM dependencies used in the `tools` module to 9.4",
  "user": {
    "login": "LuciferYang",
    "id": 1475305,
    "node_id": "MDQ6VXNlcjE0NzUzMDU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1475305?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/LuciferYang",
    "html_url": "https://github.com/LuciferYang",
    "followers_url": "https://api.github.com/users/LuciferYang/followers",
    "following_url": "https://api.github.com/users/LuciferYang/following{/other_user}",
    "gists_url": "https://api.github.com/users/LuciferYang/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/LuciferYang/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/LuciferYang/subscriptions",
    "organizations_url": "https://api.github.com/users/LuciferYang/orgs",
    "repos_url": "https://api.github.com/users/LuciferYang/repos",
    "events_url": "https://api.github.com/users/LuciferYang/events{/privacy}",
    "received_events_url": "https://api.github.com/users/LuciferYang/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1406627200,
      "node_id": "MDU6TGFiZWwxNDA2NjI3MjAw",
      "url": "https://api.github.com/repos/apache/spark/labels/BUILD",
      "name": "BUILD",
      "color": "ededed",
      "default": false,
      "description": null
    },
    {
      "id": 1982110661,
      "node_id": "MDU6TGFiZWwxOTgyMTEwNjYx",
      "url": "https://api.github.com/repos/apache/spark/labels/INFRA",
      "name": "INFRA",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 10,
  "created_at": "2023-05-17T09:36:39Z",
  "updated_at": "2023-05-18T04:04:39Z",
  "closed_at": "2023-05-17T16:18:35Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/apache/spark/pulls/41198",
    "html_url": "https://github.com/apache/spark/pull/41198",
    "diff_url": "https://github.com/apache/spark/pull/41198.diff",
    "patch_url": "https://github.com/apache/spark/pull/41198.patch",
    "merged_at": null
  },
  "body": "### What changes were proposed in this pull request?\r\nThis pr aims upgrade ASM related dependencies in the `tools` module from version 7.1 to version 9.4 to make `GenerateMIMAIgnore` can process Java 17+ compiled code.\r\n\r\nAdditionally, this pr defines `asm.version` to manage versions of ASM.\r\n\r\n\r\n### Why are the changes needed?\r\nThe classpath processed by `GenerateMIMAIgnore` cannot contain Java 17+ compiled code now due to the ASM version use by `tools` module is too low, but https://github.com/bmc/classutil has not been updated for a long time, we can't solve the problem by upgrading `classutil`, so this pr make the `tools` module explicitly rely on ASM 9.4 for workaround.\r\n\r\n\r\n### Does this PR introduce _any_ user-facing change?\r\nNo\r\n\r\n\r\n### How was this patch tested?\r\n- Pass GitHub Action\r\n- Manual checked `dev/mima` due to this pr upgrade the dependency of tools module\r\n\r\n```\r\ndev/mima\r\n```\r\n\r\nand\r\n\r\n\r\n```\r\ndev/change-scala-version.sh 2.13\r\ndev/mima -Pscala-2.13\r\n```\r\n\r\n- A case that can reproduce the problem: run following script with master branch:\r\n\r\n```\r\nset -o pipefail\r\nset -e\r\n\r\nFWDIR=\"$(cd \"`dirname \"$0\"`\"/..; pwd)\"\r\ncd \"$FWDIR\"\r\nexport SPARK_HOME=$FWDIR\r\necho $SPARK_HOME\r\n\r\nif [[ -x \"$JAVA_HOME/bin/java\" ]]; then\r\n  JAVA_CMD=\"$JAVA_HOME/bin/java\"\r\nelse\r\n  JAVA_CMD=java\r\nfi\r\n\r\nTOOLS_CLASSPATH=\"$(build/sbt -DcopyDependencies=false \"export tools/fullClasspath\" | grep jar | tail -n1)\"\r\nASSEMBLY_CLASSPATH=\"$(build/sbt -DcopyDependencies=false \"export assembly/fullClasspath\" | grep jar | tail -n1)\"\r\n\r\nrm -f .generated-mima*\r\n\r\n$JAVA_CMD \\\r\n  -Xmx2g \\\r\n  -XX:+IgnoreUnrecognizedVMOptions --add-opens=java.base/java.util.jar=ALL-UNNAMED \\\r\n  -cp \"$TOOLS_CLASSPATH:$ASSEMBLY_CLASSPATH\" \\\r\n  org.apache.spark.tools.GenerateMIMAIgnore\r\n\r\nrm -f .generated-mima*\r\n```\r\n\r\n**Before**\r\n\r\n```\r\nException in thread \"main\" java.lang.IllegalArgumentException: Unsupported class file major version 61\r\n  at org.objectweb.asm.ClassReader.<init>(ClassReader.java:195)\r\n  at org.objectweb.asm.ClassReader.<init>(ClassReader.java:176)\r\n  at org.objectweb.asm.ClassReader.<init>(ClassReader.java:162)\r\n  at org.objectweb.asm.ClassReader.<init>(ClassReader.java:283)\r\n  at org.clapper.classutil.asm.ClassFile$.load(ClassFinderImpl.scala:222)\r\n  at org.clapper.classutil.ClassFinder.classData(ClassFinder.scala:404)\r\n  at org.clapper.classutil.ClassFinder.$anonfun$processOpenZip$2(ClassFinder.scala:359)\r\n  at scala.collection.Iterator$$anon$10.next(Iterator.scala:461)\r\n  at scala.collection.Iterator$$anon$11.nextCur(Iterator.scala:486)\r\n  at scala.collection.Iterator$$anon$11.hasNext(Iterator.scala:492)\r\n  at scala.collection.Iterator.toStream(Iterator.scala:1417)\r\n  at scala.collection.Iterator.toStream$(Iterator.scala:1416)\r\n  at scala.collection.AbstractIterator.toStream(Iterator.scala:1431)\r\n  at scala.collection.Iterator.$anonfun$toStream$1(Iterator.scala:1417)\r\n  at scala.collection.immutable.Stream$Cons.tail(Stream.scala:1173)\r\n  at scala.collection.immutable.Stream$Cons.tail(Stream.scala:1163)\r\n  at scala.collection.immutable.Stream.$anonfun$$plus$plus$1(Stream.scala:372)\r\n  at scala.collection.immutable.Stream$Cons.tail(Stream.scala:1173)\r\n  at scala.collection.immutable.Stream$Cons.tail(Stream.scala:1163)\r\n  at scala.collection.immutable.Stream.$anonfun$$plus$plus$1(Stream.scala:372)\r\n  at scala.collection.immutable.Stream$Cons.tail(Stream.scala:1173)\r\n  at scala.collection.immutable.Stream$Cons.tail(Stream.scala:1163)\r\n  at scala.collection.immutable.Stream.$anonfun$map$1(Stream.scala:418)\r\n  at scala.collection.immutable.Stream$Cons.tail(Stream.scala:1173)\r\n  at scala.collection.immutable.Stream$Cons.tail(Stream.scala:1163)\r\n  at scala.collection.immutable.Stream.filterImpl(Stream.scala:506)\r\n  at scala.collection.immutable.Stream$.$anonfun$filteredTail$1(Stream.scala:1260)\r\n  at scala.collection.immutable.Stream$Cons.tail(Stream.scala:1173)\r\n  at scala.collection.immutable.Stream$Cons.tail(Stream.scala:1163)\r\n  at scala.collection.immutable.Stream$.$anonfun$filteredTail$1(Stream.scala:1260)\r\n  at scala.collection.immutable.Stream$Cons.tail(Stream.scala:1173)\r\n  at scala.collection.immutable.Stream$Cons.tail(Stream.scala:1163)\r\n  at scala.collection.generic.Growable.loop$1(Growable.scala:57)\r\n  at scala.collection.generic.Growable.$plus$plus$eq(Growable.scala:61)\r\n  at scala.collection.generic.Growable.$plus$plus$eq$(Growable.scala:53)\r\n  at scala.collection.immutable.Set$SetBuilderImpl.$plus$plus$eq(Set.scala:381)\r\n  at scala.collection.immutable.Set$SetBuilderImpl.$plus$plus$eq(Set.scala:329)\r\n  at scala.collection.TraversableLike.to(TraversableLike.scala:786)\r\n  at scala.collection.TraversableLike.to$(TraversableLike.scala:783)\r\n  at scala.collection.AbstractTraversable.to(Traversable.scala:108)\r\n  at scala.collection.TraversableOnce.toSet(TraversableOnce.scala:360)\r\n  at scala.collection.TraversableOnce.toSet$(TraversableOnce.scala:360)\r\n  at scala.collection.AbstractTraversable.toSet(Traversable.scala:108)\r\n  at org.apache.spark.tools.GenerateMIMAIgnore$.getClasses(GenerateMIMAIgnore.scala:156)\r\n  at org.apache.spark.tools.GenerateMIMAIgnore$.privateWithin(GenerateMIMAIgnore.scala:57)\r\n  at org.apache.spark.tools.GenerateMIMAIgnore$.main(GenerateMIMAIgnore.scala:122)\r\n  at org.apache.spark.tools.GenerateMIMAIgnore.main(GenerateMIMAIgnore.scala)\r\n```\r\n\r\nThe script run failed without this pr due to `ASSEMBLY_CLASSPATH` contains jackson-core 2.15.0 and it contains code compiled from Java 17+\r\n\r\n<img width=\"463\" alt=\"image\" src=\"https://github.com/apache/spark/assets/1475305/85b6b269-a182-460a-9995-7b1a517c2dfe\">\r\n\r\n\r\n**After**\r\n\r\nNo more errors like `Exception in thread \"main\" java.lang.IllegalArgumentException: Unsupported class file major version 61` with this pr.\r\n",
  "closed_by": {
    "login": "srowen",
    "id": 822522,
    "node_id": "MDQ6VXNlcjgyMjUyMg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/822522?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/srowen",
    "html_url": "https://github.com/srowen",
    "followers_url": "https://api.github.com/users/srowen/followers",
    "following_url": "https://api.github.com/users/srowen/following{/other_user}",
    "gists_url": "https://api.github.com/users/srowen/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/srowen/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/srowen/subscriptions",
    "organizations_url": "https://api.github.com/users/srowen/orgs",
    "repos_url": "https://api.github.com/users/srowen/repos",
    "events_url": "https://api.github.com/users/srowen/events{/privacy}",
    "received_events_url": "https://api.github.com/users/srowen/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/apache/spark/issues/41198/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/apache/spark/issues/41198/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
