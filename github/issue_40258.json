{
  "url": "https://api.github.com/repos/apache/spark/issues/40258",
  "repository_url": "https://api.github.com/repos/apache/spark",
  "labels_url": "https://api.github.com/repos/apache/spark/issues/40258/labels{/name}",
  "comments_url": "https://api.github.com/repos/apache/spark/issues/40258/comments",
  "events_url": "https://api.github.com/repos/apache/spark/issues/40258/events",
  "html_url": "https://github.com/apache/spark/pull/40258",
  "id": 1607430308,
  "node_id": "PR_kwDOAQXtWs5LKXmx",
  "number": 40258,
  "title": "[SPARK-42655][SQL] Incorrect ambiguous column reference error",
  "user": {
    "login": "shrprasa",
    "id": 109815907,
    "node_id": "U_kgDOBouoYw",
    "avatar_url": "https://avatars.githubusercontent.com/u/109815907?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/shrprasa",
    "html_url": "https://github.com/shrprasa",
    "followers_url": "https://api.github.com/users/shrprasa/followers",
    "following_url": "https://api.github.com/users/shrprasa/following{/other_user}",
    "gists_url": "https://api.github.com/users/shrprasa/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/shrprasa/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/shrprasa/subscriptions",
    "organizations_url": "https://api.github.com/users/shrprasa/orgs",
    "repos_url": "https://api.github.com/users/shrprasa/repos",
    "events_url": "https://api.github.com/users/shrprasa/events{/privacy}",
    "received_events_url": "https://api.github.com/users/shrprasa/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1405794576,
      "node_id": "MDU6TGFiZWwxNDA1Nzk0NTc2",
      "url": "https://api.github.com/repos/apache/spark/labels/SQL",
      "name": "SQL",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 45,
  "created_at": "2023-03-02T20:18:31Z",
  "updated_at": "2023-04-04T17:02:38Z",
  "closed_at": "2023-04-04T13:16:14Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/apache/spark/pulls/40258",
    "html_url": "https://github.com/apache/spark/pull/40258",
    "diff_url": "https://github.com/apache/spark/pull/40258.diff",
    "patch_url": "https://github.com/apache/spark/pull/40258.patch",
    "merged_at": null
  },
  "body": "**What changes were proposed in this pull request?**\r\nThe result of attribute resolution should consider only unique values for the reference. If it has duplicate values, it will incorrectly result into ambiguous reference error.\r\n\r\n**Why are the changes needed?**\r\nThe below query fails incorrectly due to ambiguous reference error.\r\nval df1 = sc.parallelize(List((1,2,3,4,5),(1,2,3,4,5))).toDF(\"id\",\"col2\",\"col3\",\"col4\", \"col5\")\r\nval op_cols_mixed_case = List(\"id\",\"col2\",\"col3\",\"col4\", \"col5\", \"ID\")\r\nval df3 = df1.select(op_cols_mixed_case.head, op_cols_mixed_case.tail: _*)\r\ndf3.select(\"id\").show()\r\norg.apache.spark.sql.AnalysisException: Reference 'id' is ambiguous, could be: id, id.\r\n\r\ndf3.explain()\r\n== Physical Plan ==\r\n*(1) Project [_1#6 AS id#17, _2#7 AS col2#18, _3#8 AS col3#19, _4#9 AS col4#20, _5#10 AS col5#21, _1#6 AS ID#17]\r\n\r\nBefore the fix, attributes matched were:\r\nattributes: Vector(id#17, id#17)\r\nThus, it throws ambiguous reference error. But if we consider only unique matches, it will return correct result.\r\nunique attributes: Vector(id#17)\r\n\r\n**Does this PR introduce any user-facing change?**\r\nYes, Users migrating from Spark 2.3 to 3.x will face this error as the scenario used to work fine in Spark 2.3 but fails in Spark 3.2. After the fix, iit will work correctly as it was in Spark 2.3.\r\n\r\n**How was this patch tested?**\r\nAdded unit test.",
  "closed_by": {
    "login": "cloud-fan",
    "id": 3182036,
    "node_id": "MDQ6VXNlcjMxODIwMzY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3182036?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cloud-fan",
    "html_url": "https://github.com/cloud-fan",
    "followers_url": "https://api.github.com/users/cloud-fan/followers",
    "following_url": "https://api.github.com/users/cloud-fan/following{/other_user}",
    "gists_url": "https://api.github.com/users/cloud-fan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cloud-fan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cloud-fan/subscriptions",
    "organizations_url": "https://api.github.com/users/cloud-fan/orgs",
    "repos_url": "https://api.github.com/users/cloud-fan/repos",
    "events_url": "https://api.github.com/users/cloud-fan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cloud-fan/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/apache/spark/issues/40258/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/apache/spark/issues/40258/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
