{
  "url": "https://api.github.com/repos/apache/spark/issues/41089",
  "repository_url": "https://api.github.com/repos/apache/spark",
  "labels_url": "https://api.github.com/repos/apache/spark/issues/41089/labels{/name}",
  "comments_url": "https://api.github.com/repos/apache/spark/issues/41089/comments",
  "events_url": "https://api.github.com/repos/apache/spark/issues/41089/events",
  "html_url": "https://github.com/apache/spark/pull/41089",
  "id": 1699575267,
  "node_id": "PR_kwDOAQXtWs5P9tNN",
  "number": 41089,
  "title": "[SPARK-43404][SS] Skip reusing sst file for same version of RocksDB state store to avoid id mismatch error",
  "user": {
    "login": "anishshri-db",
    "id": 100322362,
    "node_id": "U_kgDOBfrMOg",
    "avatar_url": "https://avatars.githubusercontent.com/u/100322362?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/anishshri-db",
    "html_url": "https://github.com/anishshri-db",
    "followers_url": "https://api.github.com/users/anishshri-db/followers",
    "following_url": "https://api.github.com/users/anishshri-db/following{/other_user}",
    "gists_url": "https://api.github.com/users/anishshri-db/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/anishshri-db/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/anishshri-db/subscriptions",
    "organizations_url": "https://api.github.com/users/anishshri-db/orgs",
    "repos_url": "https://api.github.com/users/anishshri-db/repos",
    "events_url": "https://api.github.com/users/anishshri-db/events{/privacy}",
    "received_events_url": "https://api.github.com/users/anishshri-db/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1405794576,
      "node_id": "MDU6TGFiZWwxNDA1Nzk0NTc2",
      "url": "https://api.github.com/repos/apache/spark/labels/SQL",
      "name": "SQL",
      "color": "ededed",
      "default": false,
      "description": null
    },
    {
      "id": 1406587328,
      "node_id": "MDU6TGFiZWwxNDA2NTg3MzI4",
      "url": "https://api.github.com/repos/apache/spark/labels/STRUCTURED%20STREAMING",
      "name": "STRUCTURED STREAMING",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-05-08T05:54:36Z",
  "updated_at": "2023-05-08T23:29:33Z",
  "closed_at": "2023-05-08T23:29:33Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/apache/spark/pulls/41089",
    "html_url": "https://github.com/apache/spark/pull/41089",
    "diff_url": "https://github.com/apache/spark/pull/41089.diff",
    "patch_url": "https://github.com/apache/spark/pull/41089.patch",
    "merged_at": null
  },
  "body": "### What changes were proposed in this pull request?\r\nSkip reusing sst file for same version of RocksDB state store to avoid id mismatch error\r\n\r\n### Why are the changes needed?\r\nIn case of task retry on the same executor, its possible that the original task completed the phase of creating the SST files and uploading them to the object store. In this case, we also might have added an entry to the in-memory map for `versionToRocksDBFiles` for the given version. When the retry task creates the local checkpoint, its possible the file name and size is the same, but the metadata ID embedded within the file may be different. So, when we try to load this version on successful commit, the metadata zip file points to the old SST file which results in a RocksDB mismatch id error.\r\n\r\n```\r\nMismatch in unique ID on table file 24220. Expected: {9692563551998415634,4655083329411385714} Actual: {9692563551998415639,10299185534092933087} in file /local_disk0/spark-f58a741d-576f-400c-9b56-53497745ac01/executor-18e08e59-20e8-4a00-bd7e-94ad4599150b/spark-5d980399-3425-4951-894a-808b943054ea/StateStoreId(opId=2147483648,partId=53,name=default)-d89e082e-4e33-4371-8efd-78d927ad3ba3/workingDir-9928750e-f648-4013-a300-ac96cb6ec139/MANIFEST-024212\r\n```\r\n\r\nThis change avoids reusing files for the same version on the same host based on the map entries to reduce the chance of running into the error above.\r\n\r\n### Does this PR introduce _any_ user-facing change?\r\nNo\r\n\r\n\r\n### How was this patch tested?\r\nUnit test\r\n\r\nRocksDBSuite\r\n```\r\n[info] Run completed in 35 seconds, 995 milliseconds.\r\n[info] Total number of tests run: 33\r\n[info] Suites: completed 1, aborted 0\r\n[info] Tests: succeeded 33, failed 0, canceled 0, ignored 0, pending 0\r\n[info] All tests passed.\r\n```\r\n",
  "closed_by": {
    "login": "HeartSaVioR",
    "id": 1317309,
    "node_id": "MDQ6VXNlcjEzMTczMDk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1317309?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/HeartSaVioR",
    "html_url": "https://github.com/HeartSaVioR",
    "followers_url": "https://api.github.com/users/HeartSaVioR/followers",
    "following_url": "https://api.github.com/users/HeartSaVioR/following{/other_user}",
    "gists_url": "https://api.github.com/users/HeartSaVioR/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/HeartSaVioR/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/HeartSaVioR/subscriptions",
    "organizations_url": "https://api.github.com/users/HeartSaVioR/orgs",
    "repos_url": "https://api.github.com/users/HeartSaVioR/repos",
    "events_url": "https://api.github.com/users/HeartSaVioR/events{/privacy}",
    "received_events_url": "https://api.github.com/users/HeartSaVioR/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/apache/spark/issues/41089/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/apache/spark/issues/41089/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
