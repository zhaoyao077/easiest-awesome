{
  "url": "https://api.github.com/repos/apache/spark/issues/40327",
  "repository_url": "https://api.github.com/repos/apache/spark",
  "labels_url": "https://api.github.com/repos/apache/spark/issues/40327/labels{/name}",
  "comments_url": "https://api.github.com/repos/apache/spark/issues/40327/comments",
  "events_url": "https://api.github.com/repos/apache/spark/issues/40327/events",
  "html_url": "https://github.com/apache/spark/pull/40327",
  "id": 1614644208,
  "node_id": "PR_kwDOAQXtWs5LielI",
  "number": 40327,
  "title": "[SPARK-42266][PYTHON] Remove the parent directory in shell.py execution when IPython is used",
  "user": {
    "login": "HyukjinKwon",
    "id": 6477701,
    "node_id": "MDQ6VXNlcjY0Nzc3MDE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6477701?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/HyukjinKwon",
    "html_url": "https://github.com/HyukjinKwon",
    "followers_url": "https://api.github.com/users/HyukjinKwon/followers",
    "following_url": "https://api.github.com/users/HyukjinKwon/following{/other_user}",
    "gists_url": "https://api.github.com/users/HyukjinKwon/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/HyukjinKwon/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/HyukjinKwon/subscriptions",
    "organizations_url": "https://api.github.com/users/HyukjinKwon/orgs",
    "repos_url": "https://api.github.com/users/HyukjinKwon/repos",
    "events_url": "https://api.github.com/users/HyukjinKwon/events{/privacy}",
    "received_events_url": "https://api.github.com/users/HyukjinKwon/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1981527456,
      "node_id": "MDU6TGFiZWwxOTgxNTI3NDU2",
      "url": "https://api.github.com/repos/apache/spark/labels/CORE",
      "name": "CORE",
      "color": "ededed",
      "default": false,
      "description": null
    },
    {
      "id": 1982260031,
      "node_id": "MDU6TGFiZWwxOTgyMjYwMDMx",
      "url": "https://api.github.com/repos/apache/spark/labels/PYTHON",
      "name": "PYTHON",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-03-08T04:41:18Z",
  "updated_at": "2023-03-08T10:38:56Z",
  "closed_at": "2023-03-08T10:38:56Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/apache/spark/pulls/40327",
    "html_url": "https://github.com/apache/spark/pull/40327",
    "diff_url": "https://github.com/apache/spark/pull/40327.diff",
    "patch_url": "https://github.com/apache/spark/pull/40327.patch",
    "merged_at": null
  },
  "body": "### What changes were proposed in this pull request?\r\n\r\nThis PR proposes to remove the parent directory in `shell.py` execution when IPython is used. \r\n\r\nThis is a general issue for PySpark shell specifically with IPython - IPython temporarily adds the parent directory of the script into the Python path (`sys.path`), which results in searching packages under `pyspark` directory. For example, `import pandas` attempts to import `pyspark.pandas`.\r\n\r\nSo far, we haven't had such cases within PySpark itself importing code path, but Spark Connect now has the case via checking dependency checking (which attempts to import pandas) which exposes the actual problem.\r\n\r\nRunning it with IPython can easily reproduce the error:\r\n\r\n```bash\r\nPYSPARK_PYTHON=ipython bin/pyspark --remote \"local[*]\"\r\n```\r\n\r\n### Why are the changes needed?\r\n\r\nTo make PySpark shell properly import other packages even when the names conflict with subpackages (e.g., `pyspark.pandas` vs `pandas`)\r\n\r\n### Does this PR introduce _any_ user-facing change?\r\n\r\nNo to the end users:\r\n- Because this path is only inserted for `shell.py` execution, and thankfully we didn't have such relative import case so far.\r\n- It fixes the issue in the unreleased, Spark Connect.\r\n\r\n### How was this patch tested?\r\n\r\nManually tested.\r\n\r\n```bash\r\nPYSPARK_PYTHON=ipython bin/pyspark --remote \"local[*]\"\r\n```\r\n\r\n**Before:**\r\n\r\n```\r\nPython 3.9.16 | packaged by conda-forge | (main, Feb  1 2023, 21:42:20)\r\nType 'copyright', 'credits' or 'license' for more information\r\nIPython 8.10.0 -- An enhanced Interactive Python. Type '?' for help.\r\n/.../spark/python/pyspark/shell.py:45: UserWarning: Failed to initialize Spark session.\r\n  warnings.warn(\"Failed to initialize Spark session.\")\r\nTraceback (most recent call last):\r\n  File \"/.../spark/python/pyspark/shell.py\", line 40, in <module>\r\n    spark = SparkSession.builder.getOrCreate()\r\n  File \"/.../spark/python/pyspark/sql/session.py\", line 437, in getOrCreate\r\n    from pyspark.sql.connect.session import SparkSession as RemoteSparkSession\r\n  File \"/.../spark/python/pyspark/sql/connect/session.py\", line 19, in <module>\r\n    check_dependencies(__name__, __file__)\r\n  File \"/.../spark/python/pyspark/sql/connect/utils.py\", line 33, in check_dependencies\r\n    require_minimum_pandas_version()\r\n  File \"/.../spark/python/pyspark/sql/pandas/utils.py\", line 27, in require_minimum_pandas_version\r\n    import pandas\r\n  File \"/.../spark/python/pyspark/pandas/__init__.py\", line 29, in <module>\r\n    from pyspark.pandas.missing.general_functions import MissingPandasLikeGeneralFunctions\r\n  File \"/.../spark/python/pyspark/pandas/__init__.py\", line 34, in <module>\r\n    require_minimum_pandas_version()\r\n  File \"/.../spark/python/pyspark/sql/pandas/utils.py\", line 37, in require_minimum_pandas_version\r\n    if LooseVersion(pandas.__version__) < LooseVersion(minimum_pandas_version):\r\nAttributeError: partially initialized module 'pandas' has no attribute '__version__' (most likely due to a circular import)\r\n...\r\n```\r\n\r\n\r\n**After:**\r\n\r\n\r\n```\r\nPython 3.9.16 | packaged by conda-forge | (main, Feb  1 2023, 21:42:20)\r\nType 'copyright', 'credits' or 'license' for more information\r\nIPython 8.10.0 -- An enhanced Interactive Python. Type '?' for help.\r\nSetting default log level to \"WARN\".\r\nTo adjust logging level use sc.setLogLevel(newLevel). For SparkR, use setLogLevel(newLevel).\r\n23/03/08 13:30:51 WARN NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable\r\nWelcome to\r\n      ____              __\r\n     / __/__  ___ _____/ /__\r\n    _\\ \\/ _ \\/ _ `/ __/  '_/\r\n   /__ / .__/\\_,_/_/ /_/\\_\\   version 3.5.0.dev0\r\n      /_/\r\n\r\nUsing Python version 3.9.16 (main, Feb  1 2023 21:42:20)\r\nClient connected to the Spark Connect server at localhost\r\nSparkSession available as 'spark'.\r\n\r\nIn [1]:\r\n```",
  "closed_by": {
    "login": "HyukjinKwon",
    "id": 6477701,
    "node_id": "MDQ6VXNlcjY0Nzc3MDE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6477701?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/HyukjinKwon",
    "html_url": "https://github.com/HyukjinKwon",
    "followers_url": "https://api.github.com/users/HyukjinKwon/followers",
    "following_url": "https://api.github.com/users/HyukjinKwon/following{/other_user}",
    "gists_url": "https://api.github.com/users/HyukjinKwon/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/HyukjinKwon/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/HyukjinKwon/subscriptions",
    "organizations_url": "https://api.github.com/users/HyukjinKwon/orgs",
    "repos_url": "https://api.github.com/users/HyukjinKwon/repos",
    "events_url": "https://api.github.com/users/HyukjinKwon/events{/privacy}",
    "received_events_url": "https://api.github.com/users/HyukjinKwon/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/apache/spark/issues/40327/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/apache/spark/issues/40327/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
