{
  "url": "https://api.github.com/repos/apache/spark/issues/40393",
  "repository_url": "https://api.github.com/repos/apache/spark",
  "labels_url": "https://api.github.com/repos/apache/spark/issues/40393/labels{/name}",
  "comments_url": "https://api.github.com/repos/apache/spark/issues/40393/comments",
  "events_url": "https://api.github.com/repos/apache/spark/issues/40393/events",
  "html_url": "https://github.com/apache/spark/pull/40393",
  "id": 1620978467,
  "node_id": "PR_kwDOAQXtWs5L3f-9",
  "number": 40393,
  "title": "[SPARK-40082] Schedule mergeFinalize when push merge shuffleMapStage retry but no running tasks",
  "user": {
    "login": "Stove-hust",
    "id": 52523908,
    "node_id": "MDQ6VXNlcjUyNTIzOTA4",
    "avatar_url": "https://avatars.githubusercontent.com/u/52523908?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Stove-hust",
    "html_url": "https://github.com/Stove-hust",
    "followers_url": "https://api.github.com/users/Stove-hust/followers",
    "following_url": "https://api.github.com/users/Stove-hust/following{/other_user}",
    "gists_url": "https://api.github.com/users/Stove-hust/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Stove-hust/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Stove-hust/subscriptions",
    "organizations_url": "https://api.github.com/users/Stove-hust/orgs",
    "repos_url": "https://api.github.com/users/Stove-hust/repos",
    "events_url": "https://api.github.com/users/Stove-hust/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Stove-hust/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1981527456,
      "node_id": "MDU6TGFiZWwxOTgxNTI3NDU2",
      "url": "https://api.github.com/repos/apache/spark/labels/CORE",
      "name": "CORE",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 23,
  "created_at": "2023-03-13T08:25:21Z",
  "updated_at": "2023-03-22T05:08:16Z",
  "closed_at": "2023-03-22T02:22:05Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/apache/spark/pulls/40393",
    "html_url": "https://github.com/apache/spark/pull/40393",
    "diff_url": "https://github.com/apache/spark/pull/40393.diff",
    "patch_url": "https://github.com/apache/spark/pull/40393.patch",
    "merged_at": null
  },
  "body": "### What changes were proposed in this pull request?\r\nCopy the logic of handleTaskCompletion in DAGScheduler for processing the last shuffleMapTask into submitMissingTasks.\r\n\r\n\r\n### Why are the changes needed?\r\nIn condition of push-based shuffle being enabled and speculative tasks existing, a shuffleMapStage will be resubmitting once fetchFailed occurring, then its parent stages will be resubmitting firstly and it will cost some time to compute. Before the shuffleMapStage being resubmitted, its all speculative tasks success and register map output, but speculative task successful events can not trigger shuffleMergeFinalized( shuffleBlockPusher.notifyDriverAboutPushCompletion ) because this stage has been removed from runningStages.\r\n\r\nThen this stage is resubmitted, but speculative tasks have registered map output and there are no missing tasks to compute, resubmitting stages will also not trigger shuffleMergeFinalized. Eventually this stage‘s _shuffleMergedFinalized keeps false.\r\n\r\nThen AQE will submit next stages which are dependent on  this shuffleMapStage occurring fetchFailed. And in getMissingParentStages, this stage will be marked as missing and will be resubmitted, but next stages are added to waitingStages after this stage being finished, so next stages will not be submitted even though this stage's resubmitting has been finished.\r\n\r\n\r\n### Does this PR introduce _any_ user-facing change?\r\nNo\r\n\r\n\r\n### How was this patch tested?\r\nThis extreme case is very difficult to construct, and we added logs to our production environment to capture the number of problems and verify the stability of the job. I am happy to provide a timeline of the various events in which the problem arose。\r\n",
  "closed_by": {
    "login": "mridulm",
    "id": 1591700,
    "node_id": "MDQ6VXNlcjE1OTE3MDA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1591700?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mridulm",
    "html_url": "https://github.com/mridulm",
    "followers_url": "https://api.github.com/users/mridulm/followers",
    "following_url": "https://api.github.com/users/mridulm/following{/other_user}",
    "gists_url": "https://api.github.com/users/mridulm/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mridulm/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mridulm/subscriptions",
    "organizations_url": "https://api.github.com/users/mridulm/orgs",
    "repos_url": "https://api.github.com/users/mridulm/repos",
    "events_url": "https://api.github.com/users/mridulm/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mridulm/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/apache/spark/issues/40393/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/apache/spark/issues/40393/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
