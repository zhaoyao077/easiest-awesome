{
  "url": "https://api.github.com/repos/apache/spark/issues/40462",
  "repository_url": "https://api.github.com/repos/apache/spark",
  "labels_url": "https://api.github.com/repos/apache/spark/issues/40462/labels{/name}",
  "comments_url": "https://api.github.com/repos/apache/spark/issues/40462/comments",
  "events_url": "https://api.github.com/repos/apache/spark/issues/40462/events",
  "html_url": "https://github.com/apache/spark/pull/40462",
  "id": 1628622017,
  "node_id": "PR_kwDOAQXtWs5MRT-U",
  "number": 40462,
  "title": "[SPARK-42832][SQL] Remove repartition if it is the child of LocalLimit",
  "user": {
    "login": "wangyum",
    "id": 5399861,
    "node_id": "MDQ6VXNlcjUzOTk4NjE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5399861?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wangyum",
    "html_url": "https://github.com/wangyum",
    "followers_url": "https://api.github.com/users/wangyum/followers",
    "following_url": "https://api.github.com/users/wangyum/following{/other_user}",
    "gists_url": "https://api.github.com/users/wangyum/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wangyum/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wangyum/subscriptions",
    "organizations_url": "https://api.github.com/users/wangyum/orgs",
    "repos_url": "https://api.github.com/users/wangyum/repos",
    "events_url": "https://api.github.com/users/wangyum/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wangyum/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1405794576,
      "node_id": "MDU6TGFiZWwxNDA1Nzk0NTc2",
      "url": "https://api.github.com/repos/apache/spark/labels/SQL",
      "name": "SQL",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 21,
  "created_at": "2023-03-17T03:20:24Z",
  "updated_at": "2023-03-29T06:05:11Z",
  "closed_at": "2023-03-22T17:31:55Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/apache/spark/pulls/40462",
    "html_url": "https://github.com/apache/spark/pull/40462",
    "diff_url": "https://github.com/apache/spark/pull/40462.diff",
    "patch_url": "https://github.com/apache/spark/pull/40462.patch",
    "merged_at": null
  },
  "body": "### What changes were proposed in this pull request?\r\n\r\nThis PR enhances `CollapseRepartition` to remove repartition if it is the child of `LocalLimit`. Because its output is determined by the number of partitions and the expressions of the Repartition. Therefore, it is feasible to remove Repartition except for repartition by nondeterministic expressions, because users may expect to randomly take data.\r\nFor example:\r\n```sql\r\nSELECT /*+ REBALANCE */ * FROM t WHERE id > 1 LIMIT 5;\r\n```\r\n\r\nBefore this PR:\r\n```\r\n== Optimized Logical Plan ==\r\nGlobalLimit 5\r\n+- LocalLimit 5\r\n   +- RebalancePartitions\r\n      +- Filter (isnotnull(id#0L) AND (id#0L > 1))\r\n         +- Relation spark_catalog.default.t[id#0L] parquet\r\n```\r\n\r\nAfter this PR:\r\n```\r\n== Optimized Logical Plan ==\r\nGlobalLimit 5\r\n+- LocalLimit 5\r\n   +- Filter (isnotnull(id#0L) AND (id#0L > 1))\r\n      +- Relation spark_catalog.default.t[id#0L] parquet\r\n```\r\n\r\nNote that we don't remove repartition if it looks like the user might want to take data randomly. For example:\r\n```sql\r\nSELECT /*+ REPARTITION(3) */ * FROM t WHERE id > 1 LIMIT 5;\r\nSELECT * FROM t WHERE id > 1 DISTRIBUTE BY random() LIMIT 5;\r\n```\r\n\r\n### Why are the changes needed?\r\n\r\nReduce shuffle to improve query performance. The use case is that we add a repartition to improve the parallelism on a JDBC table:\r\n<img src=\"https://user-images.githubusercontent.com/5399861/225855582-c3c81c7d-4617-4104-b669-76749a7468a0.png\" width=\"400\" height=\"700\">\r\n\r\n### Does this PR introduce _any_ user-facing change?\r\n\r\nNo.\r\n\r\n### How was this patch tested?\r\n\r\nUnit test.",
  "closed_by": {
    "login": "dongjoon-hyun",
    "id": 9700541,
    "node_id": "MDQ6VXNlcjk3MDA1NDE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9700541?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dongjoon-hyun",
    "html_url": "https://github.com/dongjoon-hyun",
    "followers_url": "https://api.github.com/users/dongjoon-hyun/followers",
    "following_url": "https://api.github.com/users/dongjoon-hyun/following{/other_user}",
    "gists_url": "https://api.github.com/users/dongjoon-hyun/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dongjoon-hyun/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dongjoon-hyun/subscriptions",
    "organizations_url": "https://api.github.com/users/dongjoon-hyun/orgs",
    "repos_url": "https://api.github.com/users/dongjoon-hyun/repos",
    "events_url": "https://api.github.com/users/dongjoon-hyun/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dongjoon-hyun/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/apache/spark/issues/40462/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/apache/spark/issues/40462/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
