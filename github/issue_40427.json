{
  "url": "https://api.github.com/repos/apache/spark/issues/40427",
  "repository_url": "https://api.github.com/repos/apache/spark",
  "labels_url": "https://api.github.com/repos/apache/spark/issues/40427/labels{/name}",
  "comments_url": "https://api.github.com/repos/apache/spark/issues/40427/comments",
  "events_url": "https://api.github.com/repos/apache/spark/issues/40427/events",
  "html_url": "https://github.com/apache/spark/pull/40427",
  "id": 1624417085,
  "node_id": "PR_kwDOAQXtWs5MDFGK",
  "number": 40427,
  "title": "[SPARK-42792][SS] Add support for WRITE_FLUSH_BYTES for RocksDB used in streaming stateful operators",
  "user": {
    "login": "anishshri-db",
    "id": 100322362,
    "node_id": "U_kgDOBfrMOg",
    "avatar_url": "https://avatars.githubusercontent.com/u/100322362?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/anishshri-db",
    "html_url": "https://github.com/anishshri-db",
    "followers_url": "https://api.github.com/users/anishshri-db/followers",
    "following_url": "https://api.github.com/users/anishshri-db/following{/other_user}",
    "gists_url": "https://api.github.com/users/anishshri-db/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/anishshri-db/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/anishshri-db/subscriptions",
    "organizations_url": "https://api.github.com/users/anishshri-db/orgs",
    "repos_url": "https://api.github.com/users/anishshri-db/repos",
    "events_url": "https://api.github.com/users/anishshri-db/events{/privacy}",
    "received_events_url": "https://api.github.com/users/anishshri-db/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1405794576,
      "node_id": "MDU6TGFiZWwxNDA1Nzk0NTc2",
      "url": "https://api.github.com/repos/apache/spark/labels/SQL",
      "name": "SQL",
      "color": "ededed",
      "default": false,
      "description": null
    },
    {
      "id": 1406587328,
      "node_id": "MDU6TGFiZWwxNDA2NTg3MzI4",
      "url": "https://api.github.com/repos/apache/spark/labels/STRUCTURED%20STREAMING",
      "name": "STRUCTURED STREAMING",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-03-14T22:46:25Z",
  "updated_at": "2023-03-15T06:53:54Z",
  "closed_at": "2023-03-15T06:53:54Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/apache/spark/pulls/40427",
    "html_url": "https://github.com/apache/spark/pull/40427",
    "diff_url": "https://github.com/apache/spark/pull/40427.diff",
    "patch_url": "https://github.com/apache/spark/pull/40427.patch",
    "merged_at": null
  },
  "body": "### What changes were proposed in this pull request?\r\nAdd support for WRITE_FLUSH_BYTES for RocksDB used in streaming stateful operators\r\n\r\n### Why are the changes needed?\r\nIts useful to get this metric for bytes written during flush from RocksDB as part of the DB custom metrics. We propose to add this to the existing metrics that are collected. There is no additional overhead since we are just querying the internal ticker guage, similar to other metrics.\r\n\r\n\r\n### Does this PR introduce _any_ user-facing change?\r\nNo\r\n\r\n\r\n### How was this patch tested?\r\nAdded unit test\r\n```\r\n[info] Run completed in 45 seconds, 260 milliseconds.\r\n[info] Total number of tests run: 18\r\n[info] Suites: completed 1, aborted 0\r\n[info] Tests: succeeded 18, failed 0, canceled 0, ignored 0, pending 0\r\n[info] All tests passed.\r\n[success] Total time: 152 s (02:32), completed Mar 14, 2023, 3:43:41 PM\r\n```\r\n\r\nInfo log on executor:\r\n```\r\nStateStoreId(opId=0,partId=3,name=default): Committed 2, stats = {\"numCommittedKeys\":4,\"numUncommittedKeys\":4,\"totalMemUsageBytes\":7818,\"writeBatchMemUsageBytes\":272,\"totalSSTFilesBytes\":2614,\"nativeOpsHistograms\":{\"get\":{\"sum\":14,\"avg\":7.0,\"stddev\":1.0,\"media\r\nn\":6.0,\"p95\":8.0,\"p99\":8.0,\"count\":2},\"put\":{\"sum\":37966,\"avg\":37966.0,\"stddev\":0.0,\"median\":37966.0,\"p95\":37966.0,\"p99\":37966.0,\"count\":1},\"compaction\":{\"sum\":0,\"avg\":0.0,\"stddev\":0.0,\"median\":0.0,\"p95\":0.0,\"p99\":0.0,\"count\":0}},\"lastCommitLatencyMs\":{\"fileSync\":188,\"writeBatch\":37,\"flush\":61,\"pause\":0,\"checkpoint\":61,\"compact\":0}\r\n,\"filesCopied\":1,\"bytesCopied\":1280,\"filesReused\":1,\"zipFileBytesUncompressed\":7675,\"nativeOpsMetrics\":{\"writerStallDuration\":0,\"totalBytesReadThroughIterator\":254,\"totalBytesWrittenByFlush\":1490,\"readBlockCacheHitCount\":2,\"totalBytesWrittenByCompaction\":0,\"readBlockCacheMissCount\":0,\"totalBytesReadByCompaction\":0,\"totalBytesWritte\r\nn\":272,\"totalBytesRead\":73}}\r\n```\r\n\r\nInfo log on driver:\r\n```\r\n    \"customMetrics\" : {\r\n      \"rocksdbBytesCopied\" : 2544,\r\n      \"rocksdbCommitCheckpointLatency\" : 416,\r\n      \"rocksdbCommitCompactLatency\" : 0,\r\n      \"rocksdbCommitFileSyncLatencyMs\" : 742,\r\n      \"rocksdbCommitFlushLatency\" : 194,\r\n      \"rocksdbCommitPauseLatency\" : 0,\r\n      \"rocksdbCommitWriteBatchLatency\" : 132,\r\n      \"rocksdbFilesCopied\" : 2,\r\n      \"rocksdbFilesReused\" : 2,\r\n      \"rocksdbGetCount\" : 4,\r\n      \"rocksdbGetLatency\" : 0,\r\n      \"rocksdbPutCount\" : 5,\r\n      \"rocksdbPutLatency\" : 132,\r\n      \"rocksdbReadBlockCacheHitCount\" : 4,\r\n      \"rocksdbReadBlockCacheMissCount\" : 0,\r\n      \"rocksdbSstFileSize\" : 5143,\r\n      \"rocksdbTotalBytesRead\" : 138,\r\n      \"rocksdbTotalBytesReadByCompaction\" : 0,\r\n      \"rocksdbTotalBytesReadThroughIterator\" : 714,\r\n      \"rocksdbTotalBytesWritten\" : 548,\r\n      \"rocksdbTotalBytesWrittenByCompaction\" : 0,\r\n      \"rocksdbTotalBytesWrittenByFlush\" : 2948,\r\n      \"rocksdbTotalCompactionLatencyMs\" : 0,\r\n      \"rocksdbWriterStallLatencyMs\" : 0,\r\n      \"rocksdbZipFileBytesUncompressed\" : 36542\r\n    }\r\n  } ],\r\n```\r\n",
  "closed_by": {
    "login": "HeartSaVioR",
    "id": 1317309,
    "node_id": "MDQ6VXNlcjEzMTczMDk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1317309?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/HeartSaVioR",
    "html_url": "https://github.com/HeartSaVioR",
    "followers_url": "https://api.github.com/users/HeartSaVioR/followers",
    "following_url": "https://api.github.com/users/HeartSaVioR/following{/other_user}",
    "gists_url": "https://api.github.com/users/HeartSaVioR/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/HeartSaVioR/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/HeartSaVioR/subscriptions",
    "organizations_url": "https://api.github.com/users/HeartSaVioR/orgs",
    "repos_url": "https://api.github.com/users/HeartSaVioR/repos",
    "events_url": "https://api.github.com/users/HeartSaVioR/events{/privacy}",
    "received_events_url": "https://api.github.com/users/HeartSaVioR/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/apache/spark/issues/40427/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/apache/spark/issues/40427/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
