{
  "url": "https://api.github.com/repos/apache/spark/issues/40811",
  "repository_url": "https://api.github.com/repos/apache/spark",
  "labels_url": "https://api.github.com/repos/apache/spark/issues/40811/labels{/name}",
  "comments_url": "https://api.github.com/repos/apache/spark/issues/40811/comments",
  "events_url": "https://api.github.com/repos/apache/spark/issues/40811/events",
  "html_url": "https://github.com/apache/spark/pull/40811",
  "id": 1670143927,
  "node_id": "PR_kwDOAQXtWs5ObGA_",
  "number": 40811,
  "title": "[SPARK-43098][SQL] Fix correctness COUNT bug when scalar subquery has group by clause",
  "user": {
    "login": "jchen5",
    "id": 790409,
    "node_id": "MDQ6VXNlcjc5MDQwOQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/790409?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jchen5",
    "html_url": "https://github.com/jchen5",
    "followers_url": "https://api.github.com/users/jchen5/followers",
    "following_url": "https://api.github.com/users/jchen5/following{/other_user}",
    "gists_url": "https://api.github.com/users/jchen5/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jchen5/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jchen5/subscriptions",
    "organizations_url": "https://api.github.com/users/jchen5/orgs",
    "repos_url": "https://api.github.com/users/jchen5/repos",
    "events_url": "https://api.github.com/users/jchen5/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jchen5/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1405794576,
      "node_id": "MDU6TGFiZWwxNDA1Nzk0NTc2",
      "url": "https://api.github.com/repos/apache/spark/labels/SQL",
      "name": "SQL",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2023-04-16T21:18:30Z",
  "updated_at": "2023-04-19T12:12:10Z",
  "closed_at": "2023-04-19T01:42:23Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/apache/spark/pulls/40811",
    "html_url": "https://github.com/apache/spark/pull/40811",
    "diff_url": "https://github.com/apache/spark/pull/40811.diff",
    "patch_url": "https://github.com/apache/spark/pull/40811.patch",
    "merged_at": null
  },
  "body": "### What changes were proposed in this pull request?\r\nFix a correctness bug for scalar subqueries with COUNT and a GROUP BY clause, for example:\r\n```\r\ncreate view t1(c1, c2) as values (0, 1), (1, 2);\r\ncreate view t2(c1, c2) as values (0, 2), (0, 3);\r\n\r\nselect c1, c2, (select count(*) from t2 where t1.c1 = t2.c1 group by c1) from t1;\r\n\r\n-- Correct answer: [(0, 1, 2), (1, 2, null)]\r\n+---+---+------------------+\r\n|c1 |c2 |scalarsubquery(c1)|\r\n+---+---+------------------+\r\n|0  |1  |2                 |\r\n|1  |2  |0                 |\r\n+---+---+------------------+\r\n```\r\n\r\nThis is due to a bug in our \"COUNT bug\" handling for scalar subqueries. For a subquery with COUNT aggregate but no GROUP BY clause, 0 is the correct output on empty inputs, and we use the COUNT bug handling to construct the plan that  yields 0 when there were no matched rows.\r\n\r\nBut when there is a GROUP BY clause then NULL is the correct output (i.e. there is no COUNT bug), but we still incorrectly use the COUNT bug handling and therefore incorrectly output 0. Instead, we need to only apply the COUNT bug handling when the scalar subquery had no GROUP BY clause.\r\n\r\nTo fix this, we need to track whether the scalar subquery has a GROUP BY, i.e. a non-empty groupingExpressions for the Aggregate node. This need to be checked before subquery decorrelation, because that adds the correlated outer refs to the group-by list so after that the group-by is always non-empty. We save it in a boolean in the ScalarSubquery node until later when we rewrite the subquery into a join in constructLeftJoins.\r\n\r\nThis is a long-standing bug. This bug affected both the current DecorrelateInnerQuery framework and the old code (with spark.sql.optimizer.decorrelateInnerQuery.enabled = false), and this PR fixes both.\r\n\r\nThis bug affects scalar subqueries (in RewriteCorrelatedScalarSubquery), but lateral subqueries handle it correctly in DecorrelateInnerQuery. Related: https://issues.apache.org/jira/browse/SPARK-36113\r\n\r\n### Why are the changes needed?\r\nFix a correctness bug.\r\n\r\n### Does this PR introduce _any_ user-facing change?\r\nYes, fix incorrect query results.\r\n\r\n### How was this patch tested?\r\nAdd SQL tests and unit tests. (Note that there were 2 existing unit tests for queries of this shape, which had the incorrect results as golden results.)",
  "closed_by": {
    "login": "cloud-fan",
    "id": 3182036,
    "node_id": "MDQ6VXNlcjMxODIwMzY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3182036?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cloud-fan",
    "html_url": "https://github.com/cloud-fan",
    "followers_url": "https://api.github.com/users/cloud-fan/followers",
    "following_url": "https://api.github.com/users/cloud-fan/following{/other_user}",
    "gists_url": "https://api.github.com/users/cloud-fan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cloud-fan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cloud-fan/subscriptions",
    "organizations_url": "https://api.github.com/users/cloud-fan/orgs",
    "repos_url": "https://api.github.com/users/cloud-fan/repos",
    "events_url": "https://api.github.com/users/cloud-fan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cloud-fan/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/apache/spark/issues/40811/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/apache/spark/issues/40811/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
