{
  "url": "https://api.github.com/repos/apache/spark/issues/40361",
  "repository_url": "https://api.github.com/repos/apache/spark",
  "labels_url": "https://api.github.com/repos/apache/spark/issues/40361/labels{/name}",
  "comments_url": "https://api.github.com/repos/apache/spark/issues/40361/comments",
  "events_url": "https://api.github.com/repos/apache/spark/issues/40361/events",
  "html_url": "https://github.com/apache/spark/pull/40361",
  "id": 1618458541,
  "node_id": "PR_kwDOAQXtWs5LvX4Z",
  "number": 40361,
  "title": "[SPARK_42742]access apiserver by pod env",
  "user": {
    "login": "thousandhu",
    "id": 5370302,
    "node_id": "MDQ6VXNlcjUzNzAzMDI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5370302?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/thousandhu",
    "html_url": "https://github.com/thousandhu",
    "followers_url": "https://api.github.com/users/thousandhu/followers",
    "following_url": "https://api.github.com/users/thousandhu/following{/other_user}",
    "gists_url": "https://api.github.com/users/thousandhu/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/thousandhu/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/thousandhu/subscriptions",
    "organizations_url": "https://api.github.com/users/thousandhu/orgs",
    "repos_url": "https://api.github.com/users/thousandhu/repos",
    "events_url": "https://api.github.com/users/thousandhu/events{/privacy}",
    "received_events_url": "https://api.github.com/users/thousandhu/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1406605057,
      "node_id": "MDU6TGFiZWwxNDA2NjA1MDU3",
      "url": "https://api.github.com/repos/apache/spark/labels/KUBERNETES",
      "name": "KUBERNETES",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2023-03-10T06:56:05Z",
  "updated_at": "2023-03-17T03:45:25Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/apache/spark/pulls/40361",
    "html_url": "https://github.com/apache/spark/pull/40361",
    "diff_url": "https://github.com/apache/spark/pull/40361.diff",
    "patch_url": "https://github.com/apache/spark/pull/40361.patch",
    "merged_at": null
  },
  "body": "<!--\r\nThanks for sending a pull request!  Here are some tips for you:\r\n  1. If this is your first time, please read our contributor guidelines: https://spark.apache.org/contributing.html\r\n  2. Ensure you have added or run the appropriate tests for your PR: https://spark.apache.org/developer-tools.html\r\n  3. If the PR is unfinished, add '[WIP]' in your PR title, e.g., '[WIP][SPARK-XXXX] Your PR title ...'.\r\n  4. Be sure to keep the PR description updated to reflect all changes.\r\n  5. Please write your PR title to summarize what this PR proposes.\r\n  6. If possible, provide a concise example to reproduce the issue for a faster review.\r\n  7. If you want to add a new configuration, please read the guideline first for naming configurations in\r\n     'core/src/main/scala/org/apache/spark/internal/config/ConfigEntry.scala'.\r\n  8. If you want to add or modify an error type or message, please read the guideline first in\r\n     'core/src/main/resources/error/README.md'.\r\n-->\r\n\r\n### What changes were proposed in this pull request?\r\nWhen start spark on k8s，driver pod  use spark.kubernetes.driver.master to get apiserver address. This config  us  https://kubernetes.default.svc/ as default and do not care about the apiserver port.\r\n\r\nIn our case, apiserver port is not 443 will driver will throw connectException. As k8s doc mentioned （https://kubernetes.io/docs/tasks/run-application/access-api-from-pod/#directly-accessing-the-rest-api）, we can get master url by getting KUBERNETES_SERVICE_HOST and KUBERNETES_SERVICE_PORT_HTTPS environment variables from pod. So we add a new conf spark.kubernetes.driver.master.from.pod.env to allow driver get master url from env in cluster mode on k8s\r\n\r\n\r\n### Why are the changes needed?\r\nAdd a new conf spark.kubernetes.driver.master.from.pod.env  to let the driver pod get apiserver automatically from pod env instead of by  spark.kubernetes.driver.master.\r\n\r\n### Does this PR introduce _any_ user-facing change?\r\nYes. When user set new conf spark.kubernetes.driver.master.from.pod.env as true, the logic of driver get apiserver url will changed. In some case it will help user to get right apiserver url.\r\nBy default, the conf spark.kubernetes.driver.master.from.pod.env  is false, and the driver logic changes nothing.\r\n\r\n### How was this patch tested?\r\nNo. the apiserver is mocked in unit test. we tested this feature in our k8s cluster\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/apache/spark/issues/40361/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/apache/spark/issues/40361/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
