{
  "url": "https://api.github.com/repos/apache/spark/issues/40845",
  "repository_url": "https://api.github.com/repos/apache/spark",
  "labels_url": "https://api.github.com/repos/apache/spark/issues/40845/labels{/name}",
  "comments_url": "https://api.github.com/repos/apache/spark/issues/40845/comments",
  "events_url": "https://api.github.com/repos/apache/spark/issues/40845/events",
  "html_url": "https://github.com/apache/spark/pull/40845",
  "id": 1674586307,
  "node_id": "PR_kwDOAQXtWs5Op9Gh",
  "number": 40845,
  "title": "[SPARK-43183][SS] Introduce a new callback \"onQueryIdle\" to StreamingQueryListener",
  "user": {
    "login": "HeartSaVioR",
    "id": 1317309,
    "node_id": "MDQ6VXNlcjEzMTczMDk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1317309?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/HeartSaVioR",
    "html_url": "https://github.com/HeartSaVioR",
    "followers_url": "https://api.github.com/users/HeartSaVioR/followers",
    "following_url": "https://api.github.com/users/HeartSaVioR/following{/other_user}",
    "gists_url": "https://api.github.com/users/HeartSaVioR/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/HeartSaVioR/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/HeartSaVioR/subscriptions",
    "organizations_url": "https://api.github.com/users/HeartSaVioR/orgs",
    "repos_url": "https://api.github.com/users/HeartSaVioR/repos",
    "events_url": "https://api.github.com/users/HeartSaVioR/events{/privacy}",
    "received_events_url": "https://api.github.com/users/HeartSaVioR/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1405794576,
      "node_id": "MDU6TGFiZWwxNDA1Nzk0NTc2",
      "url": "https://api.github.com/repos/apache/spark/labels/SQL",
      "name": "SQL",
      "color": "ededed",
      "default": false,
      "description": null
    },
    {
      "id": 1406587328,
      "node_id": "MDU6TGFiZWwxNDA2NTg3MzI4",
      "url": "https://api.github.com/repos/apache/spark/labels/STRUCTURED%20STREAMING",
      "name": "STRUCTURED STREAMING",
      "color": "ededed",
      "default": false,
      "description": null
    },
    {
      "id": 1406605079,
      "node_id": "MDU6TGFiZWwxNDA2NjA1MDc5",
      "url": "https://api.github.com/repos/apache/spark/labels/WEB%20UI",
      "name": "WEB UI",
      "color": "ededed",
      "default": false,
      "description": null
    },
    {
      "id": 1981527456,
      "node_id": "MDU6TGFiZWwxOTgxNTI3NDU2",
      "url": "https://api.github.com/repos/apache/spark/labels/CORE",
      "name": "CORE",
      "color": "ededed",
      "default": false,
      "description": null
    },
    {
      "id": 1982260031,
      "node_id": "MDU6TGFiZWwxOTgyMjYwMDMx",
      "url": "https://api.github.com/repos/apache/spark/labels/PYTHON",
      "name": "PYTHON",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-04-19T10:02:41Z",
  "updated_at": "2023-04-20T08:21:09Z",
  "closed_at": "2023-04-20T08:21:09Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/apache/spark/pulls/40845",
    "html_url": "https://github.com/apache/spark/pull/40845",
    "diff_url": "https://github.com/apache/spark/pull/40845.diff",
    "patch_url": "https://github.com/apache/spark/pull/40845.patch",
    "merged_at": null
  },
  "body": "### What changes were proposed in this pull request?\r\n\r\nThis PR introduces a new callback \"onQueryIdle\" to StreamingQueryListener, which was a part of query progress update.\r\n\r\nThe signature of the new callback method is below:\r\n\r\n```\r\ndef onQueryIdle(event: QueryIdleEvent): Unit\r\n\r\nclass QueryIdleEvent(val id: UUID, val runId: UUID) extends Event\r\n```\r\n\r\nThis PR proposes to provide a default implementation for onQueryIdle in StreamingQueryListener so that it does not break existing implementations of streaming query listener in Scala/Java. \r\n\r\nNote that it's a behavioral change as users will receive the different callback when the streaming query is being idle for configured period of time (previously they receive the callback onQueryProgress), but this is worth doing as described in the section \"Why are the changes needed?\".\r\n\r\n### Why are the changes needed?\r\n\r\nPeople has been having a lot of confusions about query progress event on idleness query; itâ€™s not only the matter of understanding but also comes up with various types of complaints, because they tend to think the event only happens after the microbatch has finished. In addition, misunderstanding may also lead to data loss on monitoring - since we give the latest batch ID for update event on idleness, if the listener implementation blindly performs upsert the information to the external storage based on batch ID, they are in risk on losing data.\r\n\r\nThis also complicates the logic because we have to memorize the execution for the previous batch, which is arguably not necessary.\r\n\r\n### Does this PR introduce _any_ user-facing change?\r\n\r\nYes. After this change, users won't get query progress update event from idle query. Instead, they will get query idle event.\r\n\r\n### How was this patch tested?\r\n\r\nModified UTs.",
  "closed_by": {
    "login": "HeartSaVioR",
    "id": 1317309,
    "node_id": "MDQ6VXNlcjEzMTczMDk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1317309?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/HeartSaVioR",
    "html_url": "https://github.com/HeartSaVioR",
    "followers_url": "https://api.github.com/users/HeartSaVioR/followers",
    "following_url": "https://api.github.com/users/HeartSaVioR/following{/other_user}",
    "gists_url": "https://api.github.com/users/HeartSaVioR/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/HeartSaVioR/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/HeartSaVioR/subscriptions",
    "organizations_url": "https://api.github.com/users/HeartSaVioR/orgs",
    "repos_url": "https://api.github.com/users/HeartSaVioR/repos",
    "events_url": "https://api.github.com/users/HeartSaVioR/events{/privacy}",
    "received_events_url": "https://api.github.com/users/HeartSaVioR/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/apache/spark/issues/40845/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/apache/spark/issues/40845/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
