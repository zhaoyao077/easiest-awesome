{
  "url": "https://api.github.com/repos/apache/spark/issues/40766",
  "repository_url": "https://api.github.com/repos/apache/spark",
  "labels_url": "https://api.github.com/repos/apache/spark/issues/40766/labels{/name}",
  "comments_url": "https://api.github.com/repos/apache/spark/issues/40766/comments",
  "events_url": "https://api.github.com/repos/apache/spark/issues/40766/events",
  "html_url": "https://github.com/apache/spark/pull/40766",
  "id": 1665440570,
  "node_id": "PR_kwDOAQXtWs5OLjtw",
  "number": 40766,
  "title": "[SPARK-43113][SQL] Evaluate stream-side variables when generating code for a bound condition",
  "user": {
    "login": "bersprockets",
    "id": 21131848,
    "node_id": "MDQ6VXNlcjIxMTMxODQ4",
    "avatar_url": "https://avatars.githubusercontent.com/u/21131848?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bersprockets",
    "html_url": "https://github.com/bersprockets",
    "followers_url": "https://api.github.com/users/bersprockets/followers",
    "following_url": "https://api.github.com/users/bersprockets/following{/other_user}",
    "gists_url": "https://api.github.com/users/bersprockets/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bersprockets/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bersprockets/subscriptions",
    "organizations_url": "https://api.github.com/users/bersprockets/orgs",
    "repos_url": "https://api.github.com/users/bersprockets/repos",
    "events_url": "https://api.github.com/users/bersprockets/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bersprockets/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1405794576,
      "node_id": "MDU6TGFiZWwxNDA1Nzk0NTc2",
      "url": "https://api.github.com/repos/apache/spark/labels/SQL",
      "name": "SQL",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2023-04-13T00:10:53Z",
  "updated_at": "2023-04-27T22:22:23Z",
  "closed_at": "2023-04-18T04:09:50Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/apache/spark/pulls/40766",
    "html_url": "https://github.com/apache/spark/pull/40766",
    "diff_url": "https://github.com/apache/spark/pull/40766.diff",
    "patch_url": "https://github.com/apache/spark/pull/40766.patch",
    "merged_at": null
  },
  "body": "### What changes were proposed in this pull request?\r\n\r\nIn `JoinCodegenSupport#getJoinCondition`, evaluate any referenced stream-side variables before using them in the generated code.\r\n\r\nThis patch doesn't evaluate the passed stream-side variables directly, but instead evaluates a copy (`streamVars2`). This is because `SortMergeJoin#codegenFullOuter` will want to evaluate the stream-side vars within a different scope than the condition check, so we mustn't delete the initialization code from the original `ExprCode` instances.\r\n\r\n### Why are the changes needed?\r\n\r\nWhen a bound condition of a full outer join references the same stream-side column more than once, wholestage codegen generates bad code.\r\n\r\nFor example, the following query fails with a compilation error:\r\n\r\n```\r\ncreate or replace temp view v1 as\r\nselect * from values\r\n(1, 1),\r\n(2, 2),\r\n(3, 1)\r\nas v1(key, value);\r\n\r\ncreate or replace temp view v2 as\r\nselect * from values\r\n(1, 22, 22),\r\n(3, -1, -1),\r\n(7, null, null)\r\nas v2(a, b, c);\r\n\r\nselect *\r\nfrom v1\r\nfull outer join v2\r\non key = a\r\nand value > b\r\nand value > c;\r\n```\r\nThe error is:\r\n```\r\norg.codehaus.commons.compiler.CompileException: File 'generated.java', Line 277, Column 9: Redefinition of local variable \"smj_isNull_7\"\r\n```\r\nThe same error occurs with code generated from ShuffleHashJoinExec:\r\n```\r\nselect /*+ SHUFFLE_HASH(v2) */ *\r\nfrom v1\r\nfull outer join v2\r\non key = a\r\nand value > b\r\nand value > c;\r\n```\r\nIn this case, the error is:\r\n```\r\norg.codehaus.commons.compiler.CompileException: File 'generated.java', Line 174, Column 5: Redefinition of local variable \"shj_value_1\" \r\n```\r\nNeither `SortMergeJoin#codegenFullOuter` nor `ShuffledHashJoinExec#doProduce` evaluate the stream-side variables before calling `consumeFullOuterJoinRow#getJoinCondition`. As a result, `getJoinCondition` generates definition/initialization code for each referenced stream-side variable at the point of use. If a stream-side variable is used more than once in the bound condition, the definition/initialization code is generated more than once, resulting in the \"Redefinition of local variable\" error.\r\n\r\nIn the end, the query succeeds, since Spark disables wholestage codegen and tries again.\r\n\r\n(In the case other join-type/strategy pairs, either the implementations don't call `JoinCodegenSupport#getJoinCondition`, or the stream-side variables are pre-evaluated before the call is made, so no error happens in those cases).\r\n\r\n### Does this PR introduce _any_ user-facing change?\r\n\r\nNo.\r\n\r\n### How was this patch tested?\r\n\r\nNew unit tests.\r\n",
  "closed_by": {
    "login": "HyukjinKwon",
    "id": 6477701,
    "node_id": "MDQ6VXNlcjY0Nzc3MDE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6477701?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/HyukjinKwon",
    "html_url": "https://github.com/HyukjinKwon",
    "followers_url": "https://api.github.com/users/HyukjinKwon/followers",
    "following_url": "https://api.github.com/users/HyukjinKwon/following{/other_user}",
    "gists_url": "https://api.github.com/users/HyukjinKwon/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/HyukjinKwon/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/HyukjinKwon/subscriptions",
    "organizations_url": "https://api.github.com/users/HyukjinKwon/orgs",
    "repos_url": "https://api.github.com/users/HyukjinKwon/repos",
    "events_url": "https://api.github.com/users/HyukjinKwon/events{/privacy}",
    "received_events_url": "https://api.github.com/users/HyukjinKwon/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/apache/spark/issues/40766/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/apache/spark/issues/40766/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
