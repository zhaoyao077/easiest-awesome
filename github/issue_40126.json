{
  "url": "https://api.github.com/repos/apache/spark/issues/40126",
  "repository_url": "https://api.github.com/repos/apache/spark",
  "labels_url": "https://api.github.com/repos/apache/spark/issues/40126/labels{/name}",
  "comments_url": "https://api.github.com/repos/apache/spark/issues/40126/comments",
  "events_url": "https://api.github.com/repos/apache/spark/issues/40126/events",
  "html_url": "https://github.com/apache/spark/pull/40126",
  "id": 1595574758,
  "node_id": "PR_kwDOAQXtWs5Kid-Y",
  "number": 40126,
  "title": "[SPARK-40822][SQL] Stable derived column aliases",
  "user": {
    "login": "MaxGekk",
    "id": 1580697,
    "node_id": "MDQ6VXNlcjE1ODA2OTc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1580697?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/MaxGekk",
    "html_url": "https://github.com/MaxGekk",
    "followers_url": "https://api.github.com/users/MaxGekk/followers",
    "following_url": "https://api.github.com/users/MaxGekk/following{/other_user}",
    "gists_url": "https://api.github.com/users/MaxGekk/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/MaxGekk/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/MaxGekk/subscriptions",
    "organizations_url": "https://api.github.com/users/MaxGekk/orgs",
    "repos_url": "https://api.github.com/users/MaxGekk/repos",
    "events_url": "https://api.github.com/users/MaxGekk/events{/privacy}",
    "received_events_url": "https://api.github.com/users/MaxGekk/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1405794576,
      "node_id": "MDU6TGFiZWwxNDA1Nzk0NTc2",
      "url": "https://api.github.com/repos/apache/spark/labels/SQL",
      "name": "SQL",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2023-02-22T18:13:09Z",
  "updated_at": "2023-03-30T14:04:00Z",
  "closed_at": "2023-03-21T06:14:33Z",
  "author_association": "MEMBER",
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/apache/spark/pulls/40126",
    "html_url": "https://github.com/apache/spark/pull/40126",
    "diff_url": "https://github.com/apache/spark/pull/40126.diff",
    "patch_url": "https://github.com/apache/spark/pull/40126.patch",
    "merged_at": null
  },
  "body": "### What changes were proposed in this pull request?\r\nIn the PR, I propose to change auto-generation of column aliases (the case when an user doesn't assign any alias explicitly). Before the changes, Spark SQL generates such alias from `Expression` but this PR proposes to take the parse tree (output of lexer), and generate an alias using the term tokens from the tree.\r\n\r\nNew helper function `ParserUtils.toExprAlias` takes a `ParseTree` from `Antlr4`, and converts it to a `String` using the following simple rule:\r\n- Concatenate all terminal nodes of the lexer tree without any gaps.\r\n- Upper case keywords and numeric literals.\r\n\r\nFor example, the sequence of tokens \"1\", \"in\", \"(\", \"1.0d\" \")\" is converted to the alias \"1IN(1.0D)\".\r\n\r\nBy default, the feature is off, and the SQL config `spark.sql.stableDerivedColumnAlias.enabled` allows to enable it.\r\n\r\nCloses #39332 \r\n\r\n### Why are the changes needed?\r\nTo improve user experience with Spark SQL. It is always best practice to name the result of any expressions in a queries select list,  if one plans to reference them later. This yields the most readable results and stability. However, sometimes queries are generated or we’re just lazy and trust in the auto generated names. The problem is that the auto-generated names are produced by pretty printing the expression tree which is, while “generally” readable, not meant to be stable across long durations of time. For example:\r\n```sql\r\nspark-sql> DESC SELECT substring('hello', 5);\r\nsubstring(hello, 5, 2147483647)\tstring\r\n```\r\nthe auto-generated column alias `substring(hello, 5, 2147483647)` contains not-obvious elements.\r\n\r\n### Does this PR introduce _any_ user-facing change?\r\nYes.\r\n\r\n### How was this patch tested?\r\nBy running new test:\r\n```\r\n$ build/sbt \"test:testOnly *.ResolveAliasesSuite\"\r\n```",
  "closed_by": {
    "login": "MaxGekk",
    "id": 1580697,
    "node_id": "MDQ6VXNlcjE1ODA2OTc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1580697?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/MaxGekk",
    "html_url": "https://github.com/MaxGekk",
    "followers_url": "https://api.github.com/users/MaxGekk/followers",
    "following_url": "https://api.github.com/users/MaxGekk/following{/other_user}",
    "gists_url": "https://api.github.com/users/MaxGekk/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/MaxGekk/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/MaxGekk/subscriptions",
    "organizations_url": "https://api.github.com/users/MaxGekk/orgs",
    "repos_url": "https://api.github.com/users/MaxGekk/repos",
    "events_url": "https://api.github.com/users/MaxGekk/events{/privacy}",
    "received_events_url": "https://api.github.com/users/MaxGekk/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/apache/spark/issues/40126/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/apache/spark/issues/40126/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
