{
  "url": "https://api.github.com/repos/apache/spark/issues/41094",
  "repository_url": "https://api.github.com/repos/apache/spark",
  "labels_url": "https://api.github.com/repos/apache/spark/issues/41094/labels{/name}",
  "comments_url": "https://api.github.com/repos/apache/spark/issues/41094/comments",
  "events_url": "https://api.github.com/repos/apache/spark/issues/41094/events",
  "html_url": "https://github.com/apache/spark/pull/41094",
  "id": 1700960769,
  "node_id": "PR_kwDOAQXtWs5QCbok",
  "number": 41094,
  "title": "[SPARK-43413][SQL] Fix IN subquery ListQuery nullability",
  "user": {
    "login": "jchen5",
    "id": 790409,
    "node_id": "MDQ6VXNlcjc5MDQwOQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/790409?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jchen5",
    "html_url": "https://github.com/jchen5",
    "followers_url": "https://api.github.com/users/jchen5/followers",
    "following_url": "https://api.github.com/users/jchen5/following{/other_user}",
    "gists_url": "https://api.github.com/users/jchen5/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jchen5/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jchen5/subscriptions",
    "organizations_url": "https://api.github.com/users/jchen5/orgs",
    "repos_url": "https://api.github.com/users/jchen5/repos",
    "events_url": "https://api.github.com/users/jchen5/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jchen5/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1405794576,
      "node_id": "MDU6TGFiZWwxNDA1Nzk0NTc2",
      "url": "https://api.github.com/repos/apache/spark/labels/SQL",
      "name": "SQL",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2023-05-08T21:22:21Z",
  "updated_at": "2023-05-17T16:03:22Z",
  "closed_at": "2023-05-16T01:41:25Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/apache/spark/pulls/41094",
    "html_url": "https://github.com/apache/spark/pull/41094",
    "diff_url": "https://github.com/apache/spark/pull/41094.diff",
    "patch_url": "https://github.com/apache/spark/pull/41094.patch",
    "merged_at": null
  },
  "body": "### What changes were proposed in this pull request?\r\nBefore this PR, IN subquery expressions are incorrectly marked as non-nullable, even when they are actually nullable. They correctly check the nullability of the left-hand-side, but the right-hand-side of a IN subquery, the ListQuery, is currently defined with nullability = false always. This is incorrect and can lead to incorrect query transformations.\r\n\r\nExample: `(non_nullable_col IN (select nullable_col)) <=> TRUE`. Here the IN expression returns NULL when the nullable_col is null, but our code marks it as non-nullable, and therefore SimplifyBinaryComparison transforms away the <=> TRUE, transforming the expression to `non_nullable_col IN (select nullable_col)`, which is an incorrect transformation because NULL values of nullable_col now cause the expression to yield NULL instead of FALSE.\r\n\r\nFix this by calculating nullability correctly from the ListQuery child output expressions.\r\n\r\nThis bug can potentially lead to wrong results, but in most cases this doesn't directly cause wrong results end-to-end, because IN subqueries are almost always transformed to semi/anti/existence joins in RewritePredicateSubquery, and this rewrite can also incorrectly discard NULLs, which is another bug. But we can observe it causing wrong behavior in unit tests at least.\r\n\r\nThis is a long-standing bug that has existed at least since 2016, as long as the ListQuery class has existed.\r\n\r\n### Why are the changes needed?\r\nFix correctness bug.\r\n\r\n### Does this PR introduce _any_ user-facing change?\r\nMay change query results to fix correctness bug.\r\n\r\n### How was this patch tested?\r\nUnit tests\r\n",
  "closed_by": {
    "login": "cloud-fan",
    "id": 3182036,
    "node_id": "MDQ6VXNlcjMxODIwMzY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3182036?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/cloud-fan",
    "html_url": "https://github.com/cloud-fan",
    "followers_url": "https://api.github.com/users/cloud-fan/followers",
    "following_url": "https://api.github.com/users/cloud-fan/following{/other_user}",
    "gists_url": "https://api.github.com/users/cloud-fan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/cloud-fan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/cloud-fan/subscriptions",
    "organizations_url": "https://api.github.com/users/cloud-fan/orgs",
    "repos_url": "https://api.github.com/users/cloud-fan/repos",
    "events_url": "https://api.github.com/users/cloud-fan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/cloud-fan/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/apache/spark/issues/41094/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/apache/spark/issues/41094/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
