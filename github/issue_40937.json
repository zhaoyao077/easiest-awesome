{
  "url": "https://api.github.com/repos/apache/spark/issues/40937",
  "repository_url": "https://api.github.com/repos/apache/spark",
  "labels_url": "https://api.github.com/repos/apache/spark/issues/40937/labels{/name}",
  "comments_url": "https://api.github.com/repos/apache/spark/issues/40937/comments",
  "events_url": "https://api.github.com/repos/apache/spark/issues/40937/events",
  "html_url": "https://github.com/apache/spark/pull/40937",
  "id": 1682498057,
  "node_id": "PR_kwDOAQXtWs5PEXdp",
  "number": 40937,
  "title": "[SPARK-42940][SS][CONNECT] Improve session management for streaming queries",
  "user": {
    "login": "rangadi",
    "id": 502522,
    "node_id": "MDQ6VXNlcjUwMjUyMg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/502522?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rangadi",
    "html_url": "https://github.com/rangadi",
    "followers_url": "https://api.github.com/users/rangadi/followers",
    "following_url": "https://api.github.com/users/rangadi/following{/other_user}",
    "gists_url": "https://api.github.com/users/rangadi/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rangadi/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rangadi/subscriptions",
    "organizations_url": "https://api.github.com/users/rangadi/orgs",
    "repos_url": "https://api.github.com/users/rangadi/repos",
    "events_url": "https://api.github.com/users/rangadi/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rangadi/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 1405794576,
      "node_id": "MDU6TGFiZWwxNDA1Nzk0NTc2",
      "url": "https://api.github.com/repos/apache/spark/labels/SQL",
      "name": "SQL",
      "color": "ededed",
      "default": false,
      "description": null
    },
    {
      "id": 1406587328,
      "node_id": "MDU6TGFiZWwxNDA2NTg3MzI4",
      "url": "https://api.github.com/repos/apache/spark/labels/STRUCTURED%20STREAMING",
      "name": "STRUCTURED STREAMING",
      "color": "ededed",
      "default": false,
      "description": null
    },
    {
      "id": 4556440342,
      "node_id": "LA_kwDOAQXtWs8AAAABD5XDFg",
      "url": "https://api.github.com/repos/apache/spark/labels/CONNECT",
      "name": "CONNECT",
      "color": "ededed",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2023-04-25T06:12:04Z",
  "updated_at": "2023-04-29T02:56:49Z",
  "closed_at": "2023-04-29T02:56:49Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/apache/spark/pulls/40937",
    "html_url": "https://github.com/apache/spark/pull/40937",
    "diff_url": "https://github.com/apache/spark/pull/40937.diff",
    "patch_url": "https://github.com/apache/spark/pull/40937.patch",
    "merged_at": null
  },
  "body": "### What changes were proposed in this pull request?\r\nThis fixes couple of important issues related to session management for streaming queries.\r\n\r\n1. Session mapping should be maintained at connect server as long as the streaming query is active, even if there are no accesses from the client side. Currently the session mapping is dropped after 1 hour of inactivity. \r\n2. When streaming query is stopped, the Spark session drops its reference to the streaming query object. That implies it can not accessed by remote spark-connect client. It is common usage pattern for users to access a streaming query after it is is stopped (e.g. to check its metrics, any exception if failed, etc). \r\n   - This is not a problem in legacy mode since the user code in the REPL keeps the reference. This is no longer the case in Spark-Connect. \r\n\r\n*Solution*: This PR adds `SparkConnectStreamingQueryCache` that does the following:\r\n  * Each new streaming query is registered with this cache.\r\n  * It runs a periodic task that checks the status of these queries and polls session mapping in connect-server so that the session stays alive.\r\n  * When query is stopped, it cached for 1 hour more so the it can be accessed from remote client. \r\n  * The full semantics are codified in the scaladoc. See [this comment](https://github.com/apache/spark/pull/40937/files#r1176846545) for more details.\r\n  \r\n### Why are the changes needed?\r\n  - Explained in the above description.\r\n\r\n### Does this PR introduce _any_ user-facing change?\r\nNo\r\n\r\n### How was this patch tested?\r\n- Unit tests\r\n- Manual testing\r\n",
  "closed_by": {
    "login": "HyukjinKwon",
    "id": 6477701,
    "node_id": "MDQ6VXNlcjY0Nzc3MDE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6477701?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/HyukjinKwon",
    "html_url": "https://github.com/HyukjinKwon",
    "followers_url": "https://api.github.com/users/HyukjinKwon/followers",
    "following_url": "https://api.github.com/users/HyukjinKwon/following{/other_user}",
    "gists_url": "https://api.github.com/users/HyukjinKwon/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/HyukjinKwon/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/HyukjinKwon/subscriptions",
    "organizations_url": "https://api.github.com/users/HyukjinKwon/orgs",
    "repos_url": "https://api.github.com/users/HyukjinKwon/repos",
    "events_url": "https://api.github.com/users/HyukjinKwon/events{/privacy}",
    "received_events_url": "https://api.github.com/users/HyukjinKwon/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/apache/spark/issues/40937/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/apache/spark/issues/40937/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
